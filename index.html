<!doctype html>
<html lang="ta">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>தமிழ் நேரம் — நாழிகை • சாமம்</title>

  <!-- Fonts: Tiro Tamil for Tamil letters, Roboto for numbers -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tiro+Tamil:ital@0;1&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#0b0c10;
      --bg1:#0f1117;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.12);
      --text:#f5f7ff;
      --muted: rgba(245,247,255,.72);
      --muted2: rgba(245,247,255,.56);
      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --radius: 18px;
      --focus: rgba(255,255,255,.22);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: "Tiro Tamil", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 900px at 20% -10%, rgba(120,90,255,.35), transparent 60%),
        radial-gradient(1000px 800px at 80% 0%, rgba(40,170,255,.28), transparent 55%),
        radial-gradient(900px 700px at 20% 100%, rgba(255,90,140,.22), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
      padding: 22px 14px 40px;
    }

    .wrap{ max-width: 820px; margin: 0 auto; }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }
    .cardInner{ padding: 16px; }

    h1{ margin:0; font-size: 20px; letter-spacing: .2px; }

    .cityTitle{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .meta{
      color: var(--muted2);
      font-size: 13px;
      line-height: 1.5;
      margin-top: 4px;
    }

    .controls{
      display:flex;
      gap: 10px;
      align-items:center;
      margin: 10px 0 14px;
      flex-wrap: wrap;
    }

    .input, .btn{
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
    }
    .input{
      flex: 1 1 260px;
      min-width: 220px;
    }
    .btn{
      cursor:pointer;
      font-weight: 700;
      background: rgba(255,255,255,.10);
      transition: transform .06s ease, background .12s ease;
      white-space: nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.14); }
    .btn:active{ transform: translateY(1px); }

    .input:focus, .btn:focus{ border-color: var(--focus); box-shadow: 0 0 0 4px rgba(255,255,255,.08); }

    /* Search dropdown */
    .searchWrap{ position: relative; flex: 1 1 260px; }
    .results{
      position:absolute;
      top: calc(100% + 8px);
      left:0; right:0;
      background: rgba(18,20,28,.92);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      overflow:hidden;
      box-shadow: 0 22px 80px rgba(0,0,0,.6);
      backdrop-filter: blur(14px);
      max-height: 320px;
      overflow-y: auto;
      z-index: 20;
      display:none;
    }
    .results.show{ display:block; }
    .item{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      cursor:pointer;
    }
    .item:last-child{ border-bottom:none; }
    .item:hover{ background: rgba(255,255,255,.08); }
    .item .name{ font-weight: 700; font-size: 13px; }
    .item .desc{ color: var(--muted2); font-size: 12px; margin-top: 2px; line-height:1.35; }

    /* Output lines */
    .lines{
      display:flex;
      flex-direction: column;
      gap: 8px;
      padding: 10px 0 2px;
    }
    .line{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 14px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.045);
      border-radius: 16px;
    }
    .label{
      color: var(--muted);
      font-size: 13px;
      flex: 0 0 auto;
    }
    .value{
      font-size: 16px;
      font-weight: 750;
      text-align:right;
      flex: 1 1 auto;
    }

    /* Numbers in Roboto */
    .num{
      font-family: "Roboto", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.2px;
    }

    /* Info details */
    details{
      margin-top: 14px;
      border: 1px dashed rgba(255,255,255,.18);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(0,0,0,.14);
    }
    summary{
      cursor:pointer;
      list-style:none;
      padding: 10px 12px;
      font-weight: 800;
      color: var(--muted);
      user-select:none;
    }
    summary::-webkit-details-marker{ display:none; }
    .detailsBody{ padding: 10px 12px 12px; color: var(--muted2); font-size: 13px; line-height: 1.6; }
    code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      color: rgba(245,247,255,.88);
    }

    .warn{
      margin-top: 10px;
      color: rgba(255,210,120,.92);
      font-size: 12px;
      line-height:1.5;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="cardInner">

        <div class="cityTitle">
          <h1 id="cityTitle">Madurai</h1>
          <div class="meta" id="sunMeta">—</div>
        </div>

        <div class="controls">
          <div class="searchWrap">
            <input id="citySearch" class="input" placeholder="Search city (default: Madurai)" autocomplete="off" />
            <div id="results" class="results"></div>
          </div>
          <input id="timeInput" class="input" type="time" step="1" style="max-width:160px" />
          <button id="nowBtn" class="btn">Now</button>
        </div>

        <!-- Only needed information (visible) -->
        <div class="lines">
          <div class="line"><div class="label">வருடம்</div><div class="value" id="outYear">—</div></div>
          <div class="line"><div class="label">பருவம்</div><div class="value" id="outSeason">—</div></div>
          <div class="line"><div class="label">மாதம்</div><div class="value" id="outMonth">—</div></div>
          <div class="line"><div class="label">நாள்</div><div class="value" id="outDayNo">—</div></div>
          <div class="line"><div class="label">கிழமை</div><div class="value" id="outWeekday">—</div></div>

          <div class="line"><div class="label">பகல் / இரவு</div><div class="value" id="outPagalIravu">—</div></div>
          <div class="line"><div class="label">சாமம்</div><div class="value" id="outSamam">—</div></div>
          <div class="line"><div class="label">நாழிகை</div><div class="value" id="outNazhi">—</div></div>
          <div class="line"><div class="label">நிமிடம்</div><div class="value" id="outMinute">—</div></div>
          <div class="line"><div class="label">வினாடி</div><div class="value" id="outVinadi">—</div></div>
        </div>

        <!-- Hidden details -->
        <details>
          <summary>Info</summary>
          <div class="detailsBody">
            <div id="infoPanch">—</div>
            <div style="margin-top:10px;">
              <code>1 நாழிகை = 24 நிமிடம்</code><br/>
              <code>1 சாமம் = 180 நிமிடம்</code><br/>
              <code>1 வினாடி (vinādi) = 24 seconds</code>
            </div>
            <div style="margin-top:10px;" id="infoCalc">—</div>
            <div class="warn" id="tzWarn" style="display:none;"></div>
          </div>
        </details>

      </div>
    </div>
  </div>

  <!-- SunCalc: sunrise/sunset only -->
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

  <script>
    // ----------------------------
    // Default city (Madurai)
    // ----------------------------
    const DEFAULT = {
      label: "Madurai, Tamil Nadu, India",
      short: "Madurai",
      lat: 9.9252,
      lon: 78.1198,
      country_code: "in"
    };
    let selected = { ...DEFAULT };

    // ----------------------------
    // Tamil solar months (approx Sankranti dates)
    // ----------------------------
    const TAMIL_MONTHS = [
      { name: "சித்திரை",  start: { m: 4,  d: 14 } },
      { name: "வைகாசி",    start: { m: 5,  d: 15 } },
      { name: "ஆனி",       start: { m: 6,  d: 15 } },
      { name: "ஆடி",       start: { m: 7,  d: 16 } },
      { name: "ஆவணி",     start: { m: 8,  d: 17 } },
      { name: "புரட்டாசி", start: { m: 9,  d: 17 } },
      { name: "ஐப்பசி",     start: { m: 10, d: 17 } },
      { name: "கார்த்திகை", start: { m: 11, d: 16 } },
      { name: "மார்கழி",   start: { m: 12, d: 16 } },
      { name: "தை",        start: { m: 1,  d: 14 } },
      { name: "மாசி",      start: { m: 2,  d: 13 } },
      { name: "பங்குனி",   start: { m: 3,  d: 14 } }
    ];

    // Tamil seasons (6 paruvam) mapped by month
    const TAMIL_SEASONS = {
      "சித்திரை": "இளவேனில்",
      "வைகாசி": "இளவேனில்",
      "ஆனி": "முதுவேனில்",
      "ஆடி": "முதுவேனில்",
      "ஆவணி": "கார்காலம்",
      "புரட்டாசி": "கார்காலம்",
      "ஐப்பசி": "கூதிர்",
      "கார்த்திகை": "கூதிர்",
      "மார்கழி": "முன்பனி",
      "தை": "முன்பனி",
      "மாசி": "பின்பனி",
      "பங்குனி": "பின்பனி"
    };

    const TAMIL_WEEKDAYS = {
      0: "ஞாயிறு", 1: "திங்கள்", 2: "செவ்வாய்", 3: "புதன்", 4: "வியாழன்", 5: "வெள்ளி", 6: "சனி"
    };

    // Tamil 60-year cycle (Prabhava starts 1987–1988)
    const TAMIL_YEAR_NAMES_60 = [
      "பிரபவ","விபவ","சுக்ல","பிரமோதூத","பிரசோற்பத்தி","ஆங்கீரச","ஸ்ரீமுக","பவ","யுவ","தாது",
      "ஈஸ்வர","வெகுதானிய","பிரமாதி","விக்கிரம","விஷு","சித்திரபானு","சுபானு","தாரண","பார்த்திப","விய",
      "சர்வசித்து","சர்வதாரி","விரோதி","விக்ருதி","கர","நந்தன","விஜய","ஜய","மன்மத","துன்முகி",
      "ஹேவிளம்பி","விளம்பி","விகாரி","சார்வரி","பிலவ","சுபகிருது","சோபகிருது","குரோதி","விசுவாசுவ","பராபவ",
      "பிலவங்க","கீலக","சௌமிய","சாதாரண","விரோதகிருது","பரிதாபி","பிரமாதீச","ஆனந்த","ராட்சச","நள",
      "பிங்கள","காளயுக்தி","சித்தார்த்தி","ரௌத்திரி","துன்மதி","துந்துபி","ருத்ரோத்காரி","ரக்தாட்சி","குரோதன","அட்சய"
    ];

    // ----------------------------
    // Panchangam (tithi/nakshatra/yoga/karana) - compact longitudes
    // ----------------------------
    const TITHI_NAMES = [
      "பிரதமை","துதியை","திருதியை","சதுர்த்தி","பஞ்சமி","சஷ்டி","சப்தமி","அஷ்டமி","நவமி","தசமி",
      "ஏகாதசி","துவாதசி","திரயோதசி","சதுர்தசி","பௌர்ணமி",
      "பிரதமை","துதியை","திருதியை","சதுர்த்தி","பஞ்சமி","சஷ்டி","சப்தமி","அஷ்டமி","நவமி","தசமி",
      "ஏகாதசி","துவாதசி","திரயோதசி","சதுர்தசி","அமாவாசை"
    ];
    function pakshaOfTithi(t){ return (t <= 15) ? "சுக்ல பக்ஷம்" : "கிருஷ்ண பக்ஷம்"; }

    const NAKSHATRA_NAMES = [
      "அஸ்வினி","பரணி","கிருத்திகை","ரோகிணி","மிருகசீரிஷம்","திருவாதிரை","புனர்பூசம்",
      "பூசம்","ஆயில்யம்","மகம்","பூரம்","உத்திரம்","ஹஸ்தம்","சித்திரை","சுவாதி","விசாகம்",
      "அனுஷம்","கேட்டை","மூலம்","பூராடம்","உத்திராடம்","திருவோணம்","அவிட்டம்","சதயம்",
      "பூரட்டாதி","உத்திரட்டாதி","ரேவதி"
    ];

    const YOGA_NAMES = [
      "விஷ்கம்பம்","பிரீதி","ஆயுஷ்மான்","சௌபாக்யம்","சோபனம்","அதிகண்டம்","சுகர்மா","த்ருதி","சூலம்","கண்டம்",
      "விருத்தி","த்ருவம்","வ்யாகாதம்","ஹர்ஷணம்","வஜ்ரம்","சித்தி","வ்யதிபாதம்","வரியான்","பரிகம்","சிவம்",
      "சித்தம்","சாத்யம்","சுபம்","சுக்லம்","ப்ரஹ்மம்","இந்த்ரம்","வைத்ருதி"
    ];

    const KARANA_FIXED = { kimstughna:"கிம்ஸ்துக்னம்", shakuni:"சகுனி", chatushpada:"சதுஷ்பாதம்", nagava:"நாகவம்" };
    const KARANA_REPEAT = ["பவம்","பாலவம்","கௌலவம்","தைதிலம்","கரம்","வணிஜம்","விஷ்டி"];

    const DEG = Math.PI/180;
    function sinD(x){ return Math.sin(x*DEG); }
    function fixAngle(deg){ deg%=360; return deg<0?deg+360:deg; }
    function jdFromDate(date){ return (date.getTime()/86400000)+2440587.5; }
    function Tcent(JD){ return (JD-2451545.0)/36525.0; }

    function sunEclipticLongitude(JD){
      const T = Tcent(JD);
      const L0 = fixAngle(280.46646 + 36000.76983*T + 0.0003032*T*T);
      const M  = fixAngle(357.52911 + 35999.05029*T - 0.0001537*T*T);
      const C =
        (1.914602 - 0.004817*T - 0.000014*T*T)*sinD(M) +
        (0.019993 - 0.000101*T)*sinD(2*M) +
        0.000289*sinD(3*M);
      const trueLon = L0 + C;
      const Omega = fixAngle(125.04 - 1934.136*T);
      const lambda = trueLon - 0.00569 - 0.00478*sinD(Omega);
      return fixAngle(lambda);
    }

    function moonEclipticLongitude(JD){
      const T = Tcent(JD);
      const L0 = fixAngle(218.3164477 + 481267.88123421*T - 0.0015786*T*T + T*T*T/538841 - T*T*T*T/65194000);
      const D  = fixAngle(297.8501921 + 445267.1114034*T - 0.0018819*T*T + T*T*T/545868 - T*T*T*T/113065000);
      const M  = fixAngle(357.5291092 + 35999.0502909*T - 0.0001536*T*T + T*T*T/24490000);
      const M1 = fixAngle(134.9633964 + 477198.8675055*T + 0.0087414*T*T + T*T*T/69699 - T*T*T*T/14712000);
      const F  = fixAngle(93.2720950  + 483202.0175233*T - 0.0036539*T*T - T*T*T/3526000 + T*T*T*T/863310000);

      const lon =
        L0
        + 6.289 * sinD(M1)
        + 1.274 * sinD(2*D - M1)
        + 0.658 * sinD(2*D)
        + 0.214 * sinD(2*M1)
        + 0.110 * sinD(D)
        - 0.186 * sinD(M)
        - 0.059 * sinD(2*D - 2*M1)
        - 0.057 * sinD(2*D - M - M1)
        + 0.053 * sinD(2*D + M1)
        + 0.046 * sinD(2*D - M)
        + 0.041 * sinD(M - M1)
        - 0.035 * sinD(D - M1)
        - 0.031 * sinD(D + M1)
        - 0.015 * sinD(2*F - 2*D)
        + 0.011 * sinD(2*F - M1);

      return fixAngle(lon);
    }

    function ayanamsaLahiriApprox(JD){
      const T = (JD-2451545.0)/36525.0;
      return 22.460148 + 1.396042*T + 0.000087*T*T;
    }

    function panchangamFromDate(date){
      const JD = jdFromDate(date);
      const sunLon = sunEclipticLongitude(JD);
      const moonLon = moonEclipticLongitude(JD);

      const diff = fixAngle(moonLon - sunLon);
      const tithiIndex = Math.floor(diff/12)+1;
      const tithiName = TITHI_NAMES[tithiIndex-1] || "—";
      const paksha = pakshaOfTithi(tithiIndex);

      const halfIndex = Math.floor(diff/6); // 0..59
      let karanaName = "—";
      if (halfIndex === 0) karanaName = KARANA_FIXED.kimstughna;
      else if (halfIndex >= 57) karanaName = [KARANA_FIXED.shakuni, KARANA_FIXED.chatushpada, KARANA_FIXED.nagava][halfIndex-57] || "—";
      else karanaName = KARANA_REPEAT[(halfIndex-1)%7];

      const ay = ayanamsaLahiriApprox(JD);
      const sunSid = fixAngle(sunLon - ay);
      const moonSid = fixAngle(moonLon - ay);

      const NSEG = 360/27;
      const nakIndex = Math.floor(moonSid/NSEG)+1;
      const nakName = NAKSHATRA_NAMES[nakIndex-1] || "—";

      const sumSid = fixAngle(sunSid + moonSid);
      const yogaIndex = Math.floor(sumSid/NSEG)+1;
      const yogaName = YOGA_NAMES[yogaIndex-1] || "—";

      return { JD, sunLon, moonLon, diff, tithiIndex, tithiName, paksha, karanaName, nakIndex, nakName, yogaIndex, yogaName, ay, sunSid, moonSid };
    }

    // ----------------------------
    // UI bindings
    // ----------------------------
    const elCityTitle = document.getElementById("cityTitle");
    const elSunMeta   = document.getElementById("sunMeta");
    const elSearch    = document.getElementById("citySearch");
    const elResults   = document.getElementById("results");
    const elTime      = document.getElementById("timeInput");
    const elNow       = document.getElementById("nowBtn");

    const outYear      = document.getElementById("outYear");
    const outSeason    = document.getElementById("outSeason");
    const outMonth     = document.getElementById("outMonth");
    const outDayNo     = document.getElementById("outDayNo");
    const outWeekday   = document.getElementById("outWeekday");
    const outPagalIravu= document.getElementById("outPagalIravu");
    const outSamam     = document.getElementById("outSamam");
    const outNazhi     = document.getElementById("outNazhi");
    const outMinute    = document.getElementById("outMinute");
    const outVinadi    = document.getElementById("outVinadi");

    const infoPanch = document.getElementById("infoPanch");
    const infoCalc  = document.getElementById("infoCalc");
    const tzWarn    = document.getElementById("tzWarn");

    function numHTML(n){ return `<span class="num">${n}</span>`; }

    function tzForSelected(){
      return (selected.country_code === "in") ? "Asia/Kolkata" : Intl.DateTimeFormat().resolvedOptions().timeZone;
    }

    function formatTime(d, tz, hour12){
      return new Intl.DateTimeFormat(undefined, {
        timeZone: tz,
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12
      }).format(d);
    }

    function datePartsInTZ(d, tz){
      const parts = new Intl.DateTimeFormat("en-CA", {
        timeZone: tz,
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false
      }).formatToParts(d);
      const get = (type) => parts.find(p => p.type === type)?.value;
      return {
        year: Number(get("year")),
        month: Number(get("month")),
        day: Number(get("day")),
        hour: Number(get("hour")),
        minute: Number(get("minute")),
        second: Number(get("second")),
      };
    }

    function setTimeInputToNow(){
      const tz = tzForSelected();
      const p = datePartsInTZ(new Date(), tz);
      elTime.value = `${String(p.hour).padStart(2,"0")}:${String(p.minute).padStart(2,"0")}:${String(p.second).padStart(2,"0")}`;
    }

    function buildTargetDateInLocalDay(){
      const now = new Date();
      const [hh, mm, ss] = (elTime.value || "00:00:00").split(":").map(Number);
      return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh||0, mm||0, ss||0, 0);
    }

    function getTamilMonthAndStart(date){
      const y = date.getFullYear();
      for (let i=0;i<TAMIL_MONTHS.length;i++){
        const curr = TAMIL_MONTHS[i];
        const next = TAMIL_MONTHS[(i+1)%12];
        const startDate = new Date(y, curr.start.m-1, curr.start.d, 0,0,0,0);
        let endDate = new Date(y, next.start.m-1, next.start.d-1, 23,59,59,999);
        if (curr.start.m > next.start.m) endDate = new Date(y+1, next.start.m-1, next.start.d-1, 23,59,59,999);
        if (date >= startDate && date <= endDate) return { month: curr.name, startDate };
      }
      return { month:"—", startDate:null };
    }

    // Tamil year name (60-year cycle), Tamil New Year approx = Apr 14
    function getTamilYearName(date){
      const y = date.getFullYear();
      const tamilNewYearApprox = new Date(y, 3, 14, 0,0,0,0); // Apr 14
      const baseYear = (date >= tamilNewYearApprox) ? y : (y - 1);
      const offset = ((baseYear - 1987) % 60 + 60) % 60; // 1987-1988 = Prabhava
      return TAMIL_YEAR_NAMES_60[offset] || "—";
    }

    // ----------------------------
    // City search (Nominatim)
    // ----------------------------
    let searchTimer = null;
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
    }
    function hideResults(){ elResults.classList.remove("show"); elResults.innerHTML = ""; }
    function showResults(items){
      elResults.innerHTML = "";
      if (!items.length) { hideResults(); return; }
      items.slice(0, 8).forEach(place => {
        const div = document.createElement("div");
        div.className = "item";
        const title = place.display_name.split(",").slice(0, 2).join(",").trim();
        div.innerHTML = `<div class="name">${escapeHtml(title)}</div><div class="desc">${escapeHtml(place.display_name)}</div>`;
        div.addEventListener("click", () => {
          const short = title;
          selected = {
            label: place.display_name,
            short,
            lat: Number(place.lat),
            lon: Number(place.lon),
            country_code: (place.address && place.address.country_code) ? place.address.country_code.toLowerCase() : ""
          };
          elSearch.value = short;
          hideResults();
          setTimeInputToNow();
          compute();
        });
        elResults.appendChild(div);
      });
      elResults.classList.add("show");
    }
    async function searchCity(q){
      const query = q.trim();
      if (query.length < 2) { hideResults(); return; }
      const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=8&q=${encodeURIComponent(query)}`;
      try{
        const res = await fetch(url, { headers: { "Accept": "application/json" }});
        const data = await res.json();
        showResults(Array.isArray(data) ? data : []);
      }catch(e){ hideResults(); }
    }

    // ----------------------------
    // Main compute (simple visible lines)
    // ----------------------------
    function compute(){
      const tz = tzForSelected();
      tzWarn.style.display = "none";
      if (selected.country_code !== "in") {
        tzWarn.style.display = "block";
        tzWarn.textContent =
          "Note: India வெளியே உள்ள நகரங்களுக்கு சரியான timezone-ஐ lat/lon மூலம் பெற API key தேவைப்படும். இப்போது device timezone பயன்படுத்தப்படுகிறது.";
      }

      const target = buildTargetDateInLocalDay();

      // Sunrise/sunset for today
      const today = new Date();
      const timesT = SunCalc.getTimes(today, selected.lat, selected.lon);
      const sunrise = timesT.sunrise;
      const sunset  = timesT.sunset;

      // Day/night
      const isPagal = (target >= sunrise && target < sunset);
      const pagalIravu = isPagal ? "பகல்" : "இரவு";

      // Samam within day/night
      const base = isPagal ? sunrise : sunset;
      const minFromBase = (target.getTime() - base.getTime()) / 60000;
      let samamNo = Math.floor(minFromBase / 180) + 1;
      samamNo = Math.max(1, Math.min(4, samamNo));

      // Naazhigai etc from sunrise (wrap 0..1440)
      const deltaMin = (target.getTime() - sunrise.getTime()) / 60000;
      const deltaSec = (target.getTime() - sunrise.getTime()) / 1000;

      const totalMinutesWrapped = ((Math.floor(deltaMin) % 1440) + 1440) % 1440;
      const dayNazhiNo = Math.floor(totalMinutesWrapped / 24) + 1; // 1..60
      const minuteInNazhi = totalMinutesWrapped % 24;

      const secondsRema = ((Math.floor(deltaSec) % 60) + 60) % 60;
      const secondsIntoNazhi = minuteInNazhi * 60 + secondsRema;
      let vinadiNo = Math.floor(secondsIntoNazhi / 24) + 1;
      vinadiNo = Math.max(1, Math.min(60, vinadiNo));

      // Tamil month/day number
      const tamilMonthInfo = getTamilMonthAndStart(target);
      const tamilMonth = tamilMonthInfo.month;

      let tamilDay = "—";
      if (tamilMonthInfo.startDate){
        const diffDays = Math.floor((target - tamilMonthInfo.startDate) / 86400000);
        tamilDay = Math.max(1, Math.min(32, diffDays + 1));
      }

      // Tamil season based on month
      const tamilSeason = TAMIL_SEASONS[tamilMonth] || "—";

      // Tamil year
      const tamilYear = getTamilYearName(target);

      // Weekday
      const weekdayTamil = TAMIL_WEEKDAYS[target.getDay()] || "—";

      // City & sunrise/sunset at top
      elCityTitle.textContent = selected.short || selected.label;
      elSunMeta.innerHTML = `Sunrise <span class="num">${formatTime(sunrise, tz, true)}</span> • Sunset <span class="num">${formatTime(sunset, tz, true)}</span>`;

      // Visible lines (order requested)
      outYear.textContent = tamilYear;
      outSeason.textContent = tamilSeason;
      outMonth.textContent = tamilMonth;
      outDayNo.innerHTML = numHTML(tamilDay);
      outWeekday.textContent = weekdayTamil;

      outPagalIravu.textContent = pagalIravu;
      outSamam.innerHTML = `${numHTML(samamNo)}வது`;
      outNazhi.innerHTML = `${numHTML(dayNazhiNo)}வது`;
      outMinute.innerHTML = numHTML(minuteInNazhi);
      outVinadi.innerHTML = `${numHTML(vinadiNo)}வது`;

      // Hidden info
      const p = panchangamFromDate(target);
      infoPanch.innerHTML =
        `<b>பஞ்சாங்கம்</b><br>` +
        `திதி: ${p.tithiName} (${p.paksha})<br>` +
        `நக்ஷத்திரம்: ${p.nakName}<br>` +
        `யோகம்: ${p.yogaName}<br>` +
        `கரணம்: ${p.karanaName}`;

      infoCalc.innerHTML =
        `<div style="margin-top:10px;"><b>Details</b></div>` +
        `<div><code>Selected: ${target.toString()}</code></div>` +
        `<div><code>JD=${p.JD.toFixed(5)} • Sunλ=${p.sunLon.toFixed(3)}° • Moonλ=${p.moonLon.toFixed(3)}°</code></div>` +
        `<div><code>Δλ=(Moon−Sun)=${p.diff.toFixed(3)}° → tithi=floor(Δλ/12)+1=${p.tithiIndex}</code></div>` +
        `<div><code>ayanāṁśa≈${p.ay.toFixed(3)}° → Moon_sid=${p.moonSid.toFixed(3)}° → nak=${p.nakIndex}</code></div>` +
        `<div><code>Naazhigai: floor(((Selected−Sunrise) mod 1440)/24)+1 = ${dayNazhiNo}</code></div>`;
    }

    // ----------------------------
    // Events
    // ----------------------------
    elSearch.addEventListener("input", () => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => searchCity(elSearch.value), 250);
    });
    elSearch.addEventListener("focus", () => { if (elResults.innerHTML.trim()) elResults.classList.add("show"); });
    document.addEventListener("click", (e) => { if (!elResults.contains(e.target) && e.target !== elSearch) hideResults(); });

    elNow.addEventListener("click", () => { setTimeInputToNow(); compute(); });
    elTime.addEventListener("change", compute);

    // ----------------------------
    // Init
    // ----------------------------
    (function init(){
      elSearch.value = "Madurai";
      selected = { ...DEFAULT };
      setTimeInputToNow();
      compute();
    })();
  </script>
</body>
</html>
