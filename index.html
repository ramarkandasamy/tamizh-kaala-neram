<!doctype html>
<html lang="ta">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <meta name="color-scheme" content="dark light" />
  <title>‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç</title>

  <!-- author info ONLY in HTML (not displayed) -->
  <meta name="author" content="Ramar Kandasamy">
  <meta name="email" content="ram.kabil@gmailcom">
  <meta name="application-name" content="‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç">
  <meta name="apple-mobile-web-app-title" content="‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç">
  <meta name="description" content="‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç ‚Äî ‡Æ®‡Ææ‡Æ¥‡Æø‡Æï‡Øà / ‡Æö‡Ææ‡ÆÆ‡ÆÆ‡Øç / ‡Æ™‡Æû‡Øç‡Æö‡Ææ‡Æô‡Øç‡Æï‡ÆÆ‡Øç.">

  <!-- PWA (you said these files already exist) -->
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Tiro+Tamil:ital,wght@0,400;1,400&display=swap" rel="stylesheet">

  <!-- Luxon -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <!-- html2canvas (share screenshot) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#070a10;
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --r:20px;
      --card:rgba(255,255,255,.055);
      --card2:rgba(0,0,0,.22);
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      background: var(--bg);
      color:var(--text);
      font-family:"Tiro Tamil", serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      background:
        radial-gradient(1100px 650px at 12% 0%, rgba(120,180,255,.16), transparent 60%),
        radial-gradient(950px 600px at 92% 25%, rgba(255,160,210,.12), transparent 55%),
        radial-gradient(1100px 700px at 50% 100%, rgba(160,255,210,.08), transparent 62%);
      transform: translateZ(0);
    }
    body::after{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      opacity:.035;
      background-image:
        repeating-linear-gradient(-25deg,
          rgba(255,255,255,.22) 0px,
          rgba(255,255,255,.22) 1px,
          transparent 1px,
          transparent 26px
        );
      transform: translateZ(0);
    }

    .wrap{position:relative;z-index:1;max-width:760px;margin:0 auto;padding:22px 14px 40px;}

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }

    .brand{display:flex;align-items:center;gap:10px;min-width:0;}

    .appIcon{
      width:38px;height:38px;
      border-radius:14px;
      border:1px solid var(--stroke);
      box-shadow:0 10px 28px rgba(0,0,0,.35);
      flex:0 0 auto;
      background:rgba(255,255,255,.06);
      object-fit:cover;
    }

    .title{min-width:0;line-height:1.15;}
    .titleRow{display:flex;align-items:center;gap:10px;min-width:0;}
    .title .h{font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .title .sub{
      font-size:12px;color:var(--muted);
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      margin-top:2px;
    }

    .pill{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.86);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      flex:0 0 auto;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
    }
    .pill:active{transform:scale(.99);}

    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end;}

    .installBtn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      display:none;
      align-items:center;
      gap:8px;
      cursor:pointer;
      box-shadow:0 10px 30px rgba(0,0,0,.22);
      transition:transform .12s ease, background .12s ease;
      user-select:none;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
      white-space:nowrap;
    }
    .installBtn:hover{background:rgba(255,255,255,.11);}
    .installBtn:active{transform:scale(.98);}
    .installBtn[disabled]{opacity:.45;cursor:not-allowed;}

    .iconbtn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.07);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      display:inline-flex;align-items:center;gap:8px;
      cursor:pointer;
      box-shadow:0 10px 30px rgba(0,0,0,.22);
      transition:transform .12s ease, background .12s ease;
      user-select:none;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
      white-space:nowrap;
    }
    .iconbtn:hover{background:rgba(255,255,255,.10);}
    .iconbtn:active{transform:scale(.98);}

    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius:20px;
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .pad{padding:14px;}
    .grid2{display:grid;grid-template-columns:1fr auto;gap:10px;margin-bottom:10px;}
    .gridPick{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:6px;}

    .input{
      width:100%;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: var(--card2);
      color:var(--text);
      padding:12px 14px;
      outline:none;
      font-size:16px;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
    }
    .btn{
      border-radius:16px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.10);
      color:var(--text);
      padding:12px 14px;
      font-size:15px;cursor:pointer;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.13);}
    .btn:active{transform:scale(.98);}

    .helper{
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      font-size:12px;color:var(--muted);
      margin:6px 2px 2px;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
    }

    .list{
      border-top:1px solid rgba(255,255,255,.07);
      padding:6px 16px 10px;
      background: rgba(0,0,0,.08);
    }
    .row{
      display:flex;justify-content:space-between;gap:14px;
      padding:11px 0;
      border-bottom:1px solid rgba(255,255,255,.06);
      align-items:baseline;
    }
    .row:last-child{border-bottom:0;}
    .k{color:var(--muted);font-size:16px;flex:0 0 auto;}
    .v{text-align:right;font-size:20px;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .big{font-size:24px;}
    .num{font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;font-variant-numeric:tabular-nums;}

    .err{
      display:none;
      margin-top:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,120,120,.22);
      background:rgba(255,80,80,.08);
      color:rgba(255,210,210,.92);
      font-size:13px;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
      white-space:pre-wrap;
    }

    details{border-top:1px solid rgba(255,255,255,.07);padding:10px 16px 14px;}
    summary{
      list-style:none;cursor:pointer;
      display:flex;justify-content:space-between;gap:10px;
      color:var(--muted);
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
      user-select:none;padding:8px 0;
    }
    summary::-webkit-details-marker{display:none;}
    .infobox{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.26);
      border-radius:16px;
      padding:12px;
      color:rgba(255,255,255,.80);
      font-size:13px;line-height:1.55;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
      white-space:pre-wrap;
    }

    .footer{
      margin-top:14px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
    }
    .donate{
      text-decoration:none;
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.08);
      color:var(--text);
    }

    body.sharing .no-share{display:none !important;}
    body.sharing details{display:none !important;}
    body.sharing .footer{display:none !important;}

    .shareStamp{
      display:none;
      margin: 10px 0 0;
      padding: 10px 16px 0;
      color: rgba(255,255,255,.86);
      font-size: 14px;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
    }
    body.sharing .shareStamp{display:block;}

    dialog{
      border:none;
      padding:0;
      border-radius:18px;
      background:rgba(12,16,24,.96);
      color:var(--text);
      width:min(560px, calc(100vw - 24px));
      box-shadow:0 28px 90px rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
    }
    dialog::backdrop{
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }
    .dlgHead{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .dlgTitle{
      display:flex;align-items:center;gap:10px;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
      font-weight:600;
    }
    .dlgClose{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
    }
    .dlgBody{
      padding:12px 14px 14px;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
      color:rgba(255,255,255,.82);
      line-height:1.55;
      font-size:13px;
      white-space:pre-wrap;
    }

    @media(max-width:520px){
      .v{font-size:19px;}
      .big{font-size:22px;}
      .actions{gap:8px;}
      .iconbtn,.installBtn{padding:10px 10px;}
      .pill{padding:6px 9px;}
    }
  </style>
</head>

<body data-app="‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç">
  <!-- AUTHOR STORED IN HTML ONLY (not shown): Ramar Kandasamy ¬∑ ram.kabil@gmailcom -->
  <div style="display:none">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç ‚Äî Author: Ramar Kandasamy ‚Äî Email: ram.kabil@gmailcom</div>

  <div class="wrap">
    <div id="shareArea">
      <div class="topbar">
        <div class="brand">
          <img class="appIcon" src="icons/icon-192.png" alt="App icon" />
          <div class="title">
            <div class="titleRow">
              <div class="h" id="cityTitle">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç</div>
              <div class="pill no-share" id="btnSafe" title="Safe PWA info">
                <span aria-hidden="true">üõ°Ô∏è</span><span>Safe PWA</span>
              </div>
            </div>
            <div class="sub">City TZ: <span id="cityTz">‚Äî</span></div>
          </div>
        </div>

        <div class="actions no-share">
          <button class="installBtn" id="btnInstall" title="Install App">
            <span aria-hidden="true">‚¨áÔ∏è</span><span class="num">Install</span>
          </button>
          <button class="iconbtn" id="btnShare" title="Share"><span aria-hidden="true">üì§</span><span class="num">Share</span></button>
          <button class="iconbtn" id="btnNow" title="Now"><span aria-hidden="true">‚è±Ô∏è</span><span class="num">Now</span></button>
          <button class="iconbtn" id="btnRefresh" title="Refresh"><span aria-hidden="true">‚Üª</span><span class="num">Refresh</span></button>
        </div>
      </div>

      <div class="shareStamp" id="shareStamp">‚Äî</div>

      <div class="card">
        <div class="pad">
          <div class="grid2 no-share">
            <input id="cityInput" class="input" placeholder="City (e.g., Madurai, Chennai, Singapore)" />
            <button id="cityGo" class="btn">Search</button>
          </div>

          <div class="gridPick no-share">
            <input id="dtInput" class="input" type="datetime-local" />
          </div>

          <div class="helper no-share">
            <div>Selected: <span class="num" id="selectedStamp">‚Äî</span></div>
          </div>

          <div class="err" id="errBox"></div>
        </div>

        <div class="list">
          <div class="row"><div class="k">‡ÆÜ‡Æ£‡Øç‡Æü‡ØÅ / ‡Æµ‡Æ∞‡ØÅ‡Æü‡ÆÆ‡Øç</div><div class="v" id="outYearBoth">‚Äî</div></div>
          <div class="row"><div class="k">‡Æ™‡Æ∞‡ØÅ‡Æµ‡ÆÆ‡Øç</div><div class="v" id="outSeason">‚Äî</div></div>
          <div class="row"><div class="k">‡ÆÆ‡Ææ‡Æ§‡ÆÆ‡Øç</div><div class="v" id="outMonth">‚Äî</div></div>
          <div class="row"><div class="k">‡Æ®‡Æü‡Øç‡Æö‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡ÆÆ‡Øç</div><div class="v" id="outNakshatra">‚Äî</div></div>
          <div class="row"><div class="k">‡Æµ‡Æ≥‡Æ∞‡Øç‡Æ™‡Æø‡Æ±‡Øà / ‡Æ§‡Øá‡ÆØ‡Øç‡Æ™‡Æø‡Æ±‡Øà</div><div class="v" id="outPaksha">‚Äî</div></div>
          <div class="row"><div class="k">‡Æ§‡Æø‡Æ§‡Æø</div><div class="v" id="outTithi">‚Äî</div></div>
          <div class="row"><div class="k">‡Æ§‡Øá‡Æ§‡Æø</div><div class="v"><span class="num" id="outDayNum">‚Äî</span></div></div>
          <div class="row"><div class="k">‡Æï‡Æø‡Æ¥‡ÆÆ‡Øà</div><div class="v" id="outWeekday">‚Äî</div></div>

          <div class="row"><div class="k">‡Æö‡Æø‡Æ±‡ØÅ‡Æ™‡Øä‡Æ¥‡ØÅ‡Æ§‡ØÅ</div><div class="v" id="outSirupozhuthu">‚Äî</div></div>
          <div class="row"><div class="k">‡Æ™‡Æï‡Æ≤‡Øç / ‡Æá‡Æ∞‡Æµ‡ØÅ</div><div class="v big" id="outDayNight">‚Äî</div></div>
          <div class="row"><div class="k">‡Æö‡Ææ‡ÆÆ‡ÆÆ‡Øç</div><div class="v"><span class="num" id="outSaamamNo">‚Äî</span> / <span class="num">8</span></div></div>
          <div class="row"><div class="k">‡Æ®‡Ææ‡Æ¥‡Æø‡Æï‡Øà</div><div class="v"><span class="num" id="outNaz">‚Äî</span> / <span class="num">60</span></div></div>
          <div class="row"><div class="k">‡Æµ‡Æø‡Æ©‡Ææ‡Æü‡Æø</div><div class="v"><span class="num" id="outVinadi">‚Äî</span></div></div>
        </div>

        <details class="no-share">
          <summary><span>Info ¬∑ Disclaimer ¬∑ Dependencies</span><span aria-hidden="true">‚ñæ</span></summary>
          <div class="infobox" id="infoBox">‚Äî</div>
        </details>
      </div>
    </div>

    <div class="footer no-share">
      <a class="donate" href="upi://pay?pa=8903448384@upi&pn=Ramar%20Kandasamy&cu=INR"><span aria-hidden="true">‚ù§Ô∏è</span> Donate <span class="num">UPI</span></a>
      <div class="num" id="footNote">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç</div>
    </div>
  </div>

  <dialog id="safeDlg" aria-label="Safe PWA Info">
    <div class="dlgHead">
      <div class="dlgTitle"><span aria-hidden="true">üõ°Ô∏è</span><span>Safe PWA</span></div>
      <button class="dlgClose" id="safeClose">Close</button>
    </div>
    <div class="dlgBody" id="safeBody">‚Äî</div>
  </dialog>

  <script>
    const { DateTime } = luxon;

    function compactErr(msg){
      const s = String(msg || "").slice(0, 180);
      return s.replace(/\\s+/g, " ").trim();
    }
    window.addEventListener("error", (e) => {
      const box = document.getElementById("errBox");
      if(!box) return;
      box.style.display = "block";
      box.textContent = `Error: ${compactErr(e.message)}`;
    });

    const APP_NAME = "‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç";
    const DEFAULT_CITY = "Madurai";

    // Register existing sw.js (you said it is already present)
    (function registerSW(){
      if(!("serviceWorker" in navigator)) return;
      navigator.serviceWorker.register("sw.js").catch(()=>{});
    })();

    // Install button logic
    let deferredPrompt = null;
    const btnInstall = document.getElementById("btnInstall");

    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      btnInstall.style.display = "inline-flex";
    });

    window.addEventListener("appinstalled", () => {
      deferredPrompt = null;
      btnInstall.style.display = "none";
    });

    btnInstall.addEventListener("click", async () => {
      if(!deferredPrompt) return;
      btnInstall.disabled = true;
      try{
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
      }catch(_e){
      }finally{
        deferredPrompt = null;
        btnInstall.style.display = "none";
        btnInstall.disabled = false;
      }
    });

    // Safe PWA dialog
    const safeDlg = document.getElementById("safeDlg");
    const safeBody = document.getElementById("safeBody");
    const btnSafe = document.getElementById("btnSafe");
    const safeClose = document.getElementById("safeClose");

    function buildSafeText(){
      return [
        "‡Æá‡Æ®‡Øç‡Æ§ App / Page ‡Æ™‡Ææ‡Æ§‡ØÅ‡Æï‡Ææ‡Æ™‡Øç‡Æ™‡Ææ‡Æ©‡Æ§‡ØÅ (Safe PWA) ‚Äî ‡Æï‡Ææ‡Æ∞‡Æ£‡Æô‡Øç‡Æï‡Æ≥‡Øç:",
        "",
        "‚Ä¢ Login ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà ‚Ä¢ Account ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà ‚Ä¢ Cookie ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà",
        "‚Ä¢ ‡Æé‡Æ®‡Øç‡Æ§ User data-‡Æµ‡ØÅ‡ÆÆ‡Øç ‡Æö‡Øá‡Æï‡Æ∞‡Æø‡Æï‡Øç‡Æï‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà / ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà",
        "‚Ä¢ Contacts / Files / GPS ‡Æ™‡Øã‡Æ©‡Øç‡Æ± permissions ‡Æï‡Øá‡Æü‡Øç‡Æï‡Æµ‡Æø‡Æ≤‡Øç‡Æ≤‡Øà",
        "‚Ä¢ ‡Æï‡Æ£‡Æï‡Øç‡Æï‡ØÅ‡Æï‡Æ≥‡Øç ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç device-‡Æ≤‡Øç (browser-‡Æ≤‡Øç) ‡Æ§‡Ææ‡Æ©‡Øç ‡Æì‡Æü‡ØÅ‡ÆÆ‡Øç",
        "‚Ä¢ Install / Offline support: manifest.json + sw.js",
        "",
        "External calls (‡Æ§‡Øá‡Æµ‡Øà‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æ™‡Øã‡Æ§‡ØÅ ‡ÆÆ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç):",
        "‚Ä¢ City search + timezone: Open-Meteo Geocoding API",
        "‚Ä¢ Sunrise/Sunset: Open-Meteo Forecast API",
        "",
        "Note:",
        "‚Ä¢ ‡Æá‡Æ®‡Øç‡Æ§ app-‡Æï‡Øç‡Æï‡ØÅ ‡Æ§‡Æ©‡Æø server ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà; ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç data ‡Æé‡Æô‡Øç‡Æï‡Æ≥‡Æø‡Æü‡ÆÆ‡Øç ‡Æö‡Øá‡ÆÆ‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Ææ‡Æ§‡ØÅ.",
        "‚Ä¢ API calls-‡Æ≤‡Øç city ‡Æ™‡ØÜ‡ÆØ‡Æ∞‡Øç + lat/lon ‡ÆÆ‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æ™‡ÆØ‡Æ©‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡ÆÆ‡Øç."
      ].join("\\n");
    }

    btnSafe?.addEventListener("click", () => {
      safeBody.textContent = buildSafeText();
      if(typeof safeDlg.showModal === "function") safeDlg.showModal();
    });
    safeClose?.addEventListener("click", () => safeDlg.close());
    safeDlg?.addEventListener("click", (e) => {
      const rect = safeDlg.getBoundingClientRect();
      const inside = (e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom);
      if(!inside) safeDlg.close();
    });

    // --- Tamil month/season table (approx) ---
    const TAMIL_MONTHS = [
      { name: "‡Æö‡Æø‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Øà",   start: { m: 4,  d: 14 }, season: "‡Æá‡Æ≥‡Æµ‡Øá‡Æ©‡Æø‡Æ≤‡Øç" },
      { name: "‡Æµ‡Øà‡Æï‡Ææ‡Æö‡Æø",    start: { m: 5,  d: 15 }, season: "‡Æá‡Æ≥‡Æµ‡Øá‡Æ©‡Æø‡Æ≤‡Øç" },
      { name: "‡ÆÜ‡Æ©‡Æø",       start: { m: 6,  d: 15 }, season: "‡ÆÆ‡ØÅ‡Æ§‡ØÅ‡Æµ‡Øá‡Æ©‡Æø‡Æ≤‡Øç" },
      { name: "‡ÆÜ‡Æü‡Æø",       start: { m: 7,  d: 16 }, season: "‡ÆÆ‡ØÅ‡Æ§‡ØÅ‡Æµ‡Øá‡Æ©‡Æø‡Æ≤‡Øç" },
      { name: "‡ÆÜ‡Æµ‡Æ£‡Æø",     start: { m: 8,  d: 16 }, season: "‡Æï‡Ææ‡Æ∞‡Øç" },
      { name: "‡Æ™‡ØÅ‡Æ∞‡Æü‡Øç‡Æü‡Ææ‡Æö‡Æø", start: { m: 9,  d: 16 }, season: "‡Æï‡Ææ‡Æ∞‡Øç" },
      { name: "‡Æê‡Æ™‡Øç‡Æ™‡Æö‡Æø",    start: { m: 10, d: 17 }, season: "‡Æï‡ØÇ‡Æ§‡Æø‡Æ∞‡Øç" },
      { name: "‡Æï‡Ææ‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡Æø‡Æï‡Øà",start: { m: 11, d: 16 }, season: "‡Æï‡ØÇ‡Æ§‡Æø‡Æ∞‡Øç" },
      { name: "‡ÆÆ‡Ææ‡Æ∞‡Øç‡Æï‡Æ¥‡Æø",   start: { m: 12, d: 16 }, season: "‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ™‡Æ©‡Æø" },
      { name: "‡Æ§‡Øà",        start: { m: 1,  d: 14 }, season: "‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ™‡Æ©‡Æø" },
      { name: "‡ÆÆ‡Ææ‡Æö‡Æø",      start: { m: 2,  d: 13 }, season: "‡Æ™‡Æø‡Æ©‡Øç‡Æ™‡Æ©‡Æø" },
      { name: "‡Æ™‡Æô‡Øç‡Æï‡ØÅ‡Æ©‡Æø",   start: { m: 3,  d: 14 }, season: "‡Æ™‡Æø‡Æ©‡Øç‡Æ™‡Æ©‡Æø" }
    ];

    // Your Tamil year list + meaning (pair data)
    const TAMIL_YEAR_LIST = [
      { no:1,  name:"‡Æ™‡Æø‡Æ∞‡Æ™‡Æµ",     meaning:"‡Æ®‡Æ±‡Øç‡Æ±‡Øã‡Æ©‡Øç‡Æ±‡Æ≤‡Øç" },
      { no:2,  name:"‡Æµ‡Æø‡Æ™‡Æµ",       meaning:"‡Æâ‡ÆØ‡Æ∞‡Øç‡Æ§‡Øã‡Æ©‡Øç‡Æ±‡Æ≤‡Øç" },
      { no:3,  name:"‡Æö‡ØÅ‡Æï‡Øç‡Æ≤",       meaning:"‡Æµ‡ØÜ‡Æ≥‡Øç‡Æ≥‡Øä‡Æ≥‡Æø" },
      { no:4,  name:"‡Æ™‡Æø‡Æ∞‡ÆÆ‡Øã‡Æ§‡ØÇ‡Æ§",   meaning:"‡Æ™‡Øá‡Æ∞‡ØÅ‡Æµ‡Æï‡Øà" },
      { no:5,  name:"‡Æ™‡Æø‡Æ∞‡Æö‡Øã‡Æ±‡Øç‡Æ™‡Æ§‡Øç‡Æ§‡Æø",meaning:"‡ÆÆ‡Æï‡Øç‡Æï‡Æü‡Øç‡Æö‡ØÜ‡Æ≤‡Øç‡Æµ‡ÆÆ‡Øç" },
      { no:6,  name:"‡ÆÜ‡Æô‡Øç‡Æï‡ØÄ‡Æ∞‡Æö",     meaning:"‡ÆÖ‡ÆØ‡Æ≤‡Øç‡ÆÆ‡ØÅ‡Æ©‡Æø" },
      { no:7,  name:"‡Æ∏‡Øç‡Æ∞‡ØÄ‡ÆÆ‡ØÅ‡Æï",     meaning:"‡Æ§‡Æø‡Æ∞‡ØÅ‡ÆÆ‡ØÅ‡Æï‡ÆÆ‡Øç" },
      { no:8,  name:"‡Æ™‡Æµ",         meaning:"‡Æ§‡Øã‡Æ±‡Øç‡Æ±‡ÆÆ‡Øç" },
      { no:9,  name:"‡ÆØ‡ØÅ‡Æµ",         meaning:"‡Æá‡Æ≥‡ÆÆ‡Øà" },
      { no:10, name:"‡Æ§‡Ææ‡Æ§‡ØÅ",        meaning:"‡ÆÆ‡Ææ‡Æ¥‡Øà" },
      { no:11, name:"‡Æà‡Æ∏‡Øç‡Æµ‡Æ∞",       meaning:"‡Æà‡Æö‡Øç‡Æö‡ØÅ‡Æ∞‡ÆÆ‡Øç" },
      { no:12, name:"‡Æµ‡ØÜ‡Æï‡ØÅ‡Æ§‡Ææ‡Æ©‡Æø‡ÆØ",  meaning:"‡Æï‡ØÇ‡Æ≤‡Æµ‡Æ≥‡ÆÆ‡Øç" },
      { no:13, name:"‡Æ™‡Æø‡Æ∞‡ÆÆ‡Ææ‡Æ§‡Æø",     meaning:"‡ÆÆ‡ØÅ‡Æ©‡Øç‡ÆÆ‡Øà" },
      { no:14, name:"‡Æµ‡Æø‡Æï‡Øç‡Æï‡Æø‡Æ∞‡ÆÆ",    meaning:"‡Æ®‡Øá‡Æ∞‡Øç‡Æ®‡Æø‡Æ∞‡Æ≤‡Øç" },
      { no:15, name:"‡Æµ‡Æø‡Æ∑‡ØÅ",        meaning:"‡Æµ‡Æø‡Æ≥‡Øà‡Æ™‡ÆØ‡Æ©‡Øç" },
      { no:16, name:"‡Æö‡Æø‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Æ™‡Ææ‡Æ©‡ØÅ", meaning:"‡Æì‡Æµ‡Æø‡ÆØ‡Æï‡Øç‡Æï‡Æ§‡Æø‡Æ∞‡Øç" },
      { no:17, name:"‡Æö‡ØÅ‡Æ™‡Ææ‡Æ©‡ØÅ",      meaning:"‡Æ®‡Æ±‡Øç‡Æï‡Æ§‡Æø‡Æ∞‡Øç" },
      { no:18, name:"‡Æ§‡Ææ‡Æ∞‡Æ£",        meaning:"‡Æ§‡Ææ‡Æô‡Øç‡Æï‡ØÜ‡Æ¥‡Æø‡Æ≤‡Øç" },
      { no:19, name:"‡Æ™‡Ææ‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡Æø‡Æ™",    meaning:"‡Æ®‡Æø‡Æ≤‡Æµ‡Æ∞‡Øà‡ÆØ‡Æ©‡Øç" },
      { no:20, name:"‡Æµ‡Æø‡ÆØ",          meaning:"‡Æµ‡Æø‡Æ∞‡Æø‡ÆÆ‡Ææ‡Æ£‡Øç‡Æ™‡ØÅ" },
      { no:21, name:"‡Æö‡Æ∞‡Øç‡Æµ‡Æö‡Æø‡Æ§‡Øç‡Æ§‡ØÅ",  meaning:"‡ÆÆ‡ØÅ‡Æ±‡Øç‡Æ±‡Æ±‡Æø‡Æµ‡ØÅ ‡ÆØ‡Ææ‡Æµ‡ØÅ‡Æ®‡Øç‡Æ§‡Æø‡Æ±‡Æ≤‡Øç" },
      { no:22, name:"‡Æö‡Æ∞‡Øç‡Æµ‡Æ§‡Ææ‡Æ∞‡Æø",    meaning:"‡ÆÆ‡ØÅ‡Æ¥‡ØÅ‡Æ®‡Æø‡Æ±‡Øà‡Æµ‡ØÅ" },
      { no:23, name:"‡Æµ‡Æø‡Æ∞‡Øã‡Æ§‡Æø",      meaning:"‡Æ§‡ØÄ‡Æ∞‡Øç‡Æ™‡Æï‡Øà" },
      { no:24, name:"‡Æµ‡Æø‡Æï‡Øç‡Æ∞‡ØÅ‡Æ§‡Æø",     meaning:"‡Æµ‡Æ≥‡ÆÆ‡Ææ‡Æ±‡Øç‡Æ±‡ÆÆ‡Øç" },
      { no:25, name:"‡Æï‡Æ∞",          meaning:"‡Æö‡ØÜ‡ÆØ‡Øç‡Æ®‡Øá‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡Æø" },
      { no:26, name:"‡Æ®‡Æ®‡Øç‡Æ§‡Æ©",       meaning:"‡Æ®‡Æ±‡Øç‡Æï‡ØÅ‡Æ¥‡Æµ‡Æø" },
      { no:27, name:"‡Æµ‡Æø‡Æú‡ÆØ",        meaning:"‡Æâ‡ÆØ‡Æ∞‡Øç‡Æµ‡Ææ‡Æï‡Øà" },
      { no:28, name:"‡Æú‡ÆØ",          meaning:"‡Æµ‡Ææ‡Æï‡Øà" },
      { no:29, name:"‡ÆÆ‡Æ©‡Øç‡ÆÆ‡Æ§",       meaning:"‡Æï‡Ææ‡Æ§‡Æ©‡Øç‡ÆÆ‡Øà" },
      { no:30, name:"‡Æ§‡ØÅ‡Æ©‡Øç‡ÆÆ‡ØÅ‡Æï‡Æø",     meaning:"‡Æµ‡ØÜ‡ÆÆ‡Øç‡ÆÆ‡ØÅ‡Æï‡ÆÆ‡Øç" },
      { no:31, name:"‡Æπ‡Øá‡Æµ‡Æø‡Æ≥‡ÆÆ‡Øç‡Æ™‡Æø",   meaning:"‡Æ™‡Øä‡Æ±‡Øç‡Æ±‡Æü‡Øà" },
      { no:32, name:"‡Æµ‡Æø‡Æ≥‡ÆÆ‡Øç‡Æ™‡Æø",      meaning:"‡ÆÖ‡Æü‡Øç‡Æü‡Æø" },
      { no:33, name:"‡Æµ‡Æø‡Æï‡Ææ‡Æ∞‡Æø",      meaning:"‡Æé‡Æ¥‡Æø‡Æ≤‡Øç‡ÆÆ‡Ææ‡Æ±‡Æ≤‡Øç" },
      { no:34, name:"‡Æö‡Ææ‡Æ∞‡Øç‡Æµ‡Æ∞‡Æø",     meaning:"‡Æµ‡ØÄ‡Æ±‡Æø‡ÆØ‡ØÜ‡Æ¥‡Æ≤‡Øç" },
      { no:35, name:"‡Æ™‡Æø‡Æ≤‡Æµ",        meaning:"‡Æï‡ØÄ‡Æ¥‡Æ±‡Øà" },
      { no:36, name:"‡Æö‡ØÅ‡Æ™‡Æï‡Æø‡Æ∞‡ØÅ‡Æ§‡ØÅ",   meaning:"‡Æ®‡Æ±‡Øç‡Æö‡ØÜ‡ÆØ‡Øç‡Æï‡Øà" },
      { no:37, name:"‡Æö‡Øã‡Æ™‡Æï‡Æø‡Æ∞‡ØÅ‡Æ§‡ØÅ",   meaning:"‡ÆÆ‡Æô‡Øç‡Æï‡Æ≤‡ÆÆ‡Øç" },
      { no:38, name:"‡Æï‡ØÅ‡Æ∞‡Øã‡Æ§‡Æø",      meaning:"‡Æ™‡Æï‡Øà‡Æï‡Øç‡Æï‡Øá‡Æü‡ØÅ" },
      { no:39, name:"‡Æµ‡Æø‡Æö‡ØÅ‡Æµ‡Ææ‡Æö‡ØÅ‡Æµ",   meaning:"‡Æâ‡Æ≤‡Æï‡Æ®‡Æø‡Æ±‡Øà‡Æµ‡ØÅ" },
      { no:40, name:"‡Æ™‡Æ∞‡Æ™‡Ææ‡Æµ",      meaning:"‡ÆÖ‡Æ∞‡ØÅ‡Æü‡Øç‡Æü‡Øã‡Æ±‡Øç‡Æ±‡ÆÆ‡Øç" },
      { no:41, name:"‡Æ™‡Æø‡Æ≤‡Æµ‡Æô‡Øç‡Æï",     meaning:"‡Æ®‡Æö‡Øç‡Æö‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ‡Æ¥‡Øà" },
      { no:42, name:"‡Æï‡ØÄ‡Æ≤‡Æï",        meaning:"‡Æ™‡Æø‡Æ£‡Øà‡Æµ‡Æø‡Æ∞‡Æï‡ØÅ" },
      { no:43, name:"‡Æö‡Øå‡ÆÆ‡Æø‡ÆØ",       meaning:"‡ÆÖ‡Æ¥‡Æï‡ØÅ" },
      { no:44, name:"‡Æö‡Ææ‡Æ§‡Ææ‡Æ∞‡Æ£",      meaning:"‡Æ™‡Øä‡Æ§‡ØÅ‡Æ®‡Æø‡Æ≤‡Øà" },
      { no:45, name:"‡Æµ‡Æø‡Æ∞‡Øã‡Æ§‡Æï‡Æø‡Æ∞‡ØÅ‡Æ§‡ØÅ", meaning:"‡Æá‡Æï‡Æ≤‡Øç‡Æµ‡ØÄ‡Æ±‡ØÅ" },
      { no:46, name:"‡Æ™‡Æ∞‡Æø‡Æ§‡Ææ‡Æ™‡Æø",     meaning:"‡Æï‡Æ¥‡Æø‡Æµ‡Æø‡Æ∞‡Æï‡Øç‡Æï‡ÆÆ‡Øç" },
      { no:47, name:"‡Æ™‡Æø‡Æ∞‡ÆÆ‡Ææ‡Æ§‡ØÄ‡Æö",    meaning:"‡Æ®‡Æ±‡Øç‡Æ±‡Æ≤‡Øà‡ÆÆ‡Øà" },
      { no:48, name:"‡ÆÜ‡Æ©‡Æ®‡Øç‡Æ§",       meaning:"‡Æ™‡ØÜ‡Æ∞‡ØÅ‡ÆÆ‡Æï‡Æø‡Æ¥‡Øç‡Æö‡Øç‡Æö‡Æø" },
      { no:49, name:"‡Æ∞‡Ææ‡Æü‡Øç‡Æö‡Æö",      meaning:"‡Æ™‡ØÜ‡Æ∞‡ØÅ‡ÆÆ‡Æ±‡ÆÆ‡Øç" },
      { no:50, name:"‡Æ®‡Æ≥",          meaning:"‡Æ§‡Ææ‡ÆÆ‡Æ∞‡Øà" },
      { no:51, name:"‡Æ™‡Æø‡Æô‡Øç‡Æï‡Æ≥",      meaning:"‡Æ™‡Øä‡Æ©‡Øç‡ÆÆ‡Øà" },
      { no:52, name:"‡Æï‡Ææ‡Æ≥‡ÆØ‡ØÅ‡Æï‡Øç‡Æ§‡Æø",  meaning:"‡Æï‡Æ∞‡ØÅ‡ÆÆ‡Øà‡Æµ‡ØÄ‡Æö‡Øç‡Æö‡ØÅ" },
      { no:53, name:"‡Æö‡Æø‡Æ§‡Øç‡Æ§‡Ææ‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡Æø",meaning:"‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡Æø‡ÆØ‡ÆÆ‡ØÅ‡Æü‡Æø‡Æ§‡Æ≤‡Øç" },
      { no:54, name:"‡Æ∞‡Øå‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Æø",    meaning:"‡ÆÖ‡Æ¥‡Æ≤‡Æø" },
      { no:55, name:"‡Æ§‡ØÅ‡Æ©‡Øç‡ÆÆ‡Æ§‡Æø",     meaning:"‡Æï‡Øä‡Æü‡ØÅ‡ÆÆ‡Æ§‡Æø" },
      { no:56, name:"‡Æ§‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ‡Æ™‡Æø",    meaning:"‡Æ™‡Øá‡Æ∞‡Æø‡Æï‡Øà" },
      { no:57, name:"‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ∞‡Øã‡Æ§‡Øç‡Æï‡Ææ‡Æ∞‡Æø",meaning:"‡Æí‡Æü‡ØÅ‡Æô‡Øç‡Æï‡Æø" },
      { no:58, name:"‡Æ∞‡Æï‡Øç‡Æ§‡Ææ‡Æü‡Øç‡Æö‡Æø",   meaning:"‡Æö‡ØÜ‡ÆÆ‡Øç‡ÆÆ‡Øà" },
      { no:59, name:"‡Æï‡ØÅ‡Æ∞‡Øã‡Æ§‡Æ©",     meaning:"‡Æé‡Æ§‡Æø‡Æ∞‡Øá‡Æ±‡Øç‡Æ±‡ÆÆ‡Øç" },
      { no:60, name:"‡ÆÖ‡Æü‡Øç‡Æö‡ÆØ",       meaning:"‡Æµ‡Æ≥‡Æô‡Øç‡Æï‡Æ≤‡Æ©‡Øç" }
    ];

    const WEEKDAY_TA = { 1:"‡Æ§‡Æø‡Æô‡Øç‡Æï‡Æ≥‡Øç",2:"‡Æö‡ØÜ‡Æµ‡Øç‡Æµ‡Ææ‡ÆØ‡Øç",3:"‡Æ™‡ØÅ‡Æ§‡Æ©‡Øç",4:"‡Æµ‡Æø‡ÆØ‡Ææ‡Æ¥‡Æ©‡Øç",5:"‡Æµ‡ØÜ‡Æ≥‡Øç‡Æ≥‡Æø",6:"‡Æö‡Æ©‡Æø",7:"‡Æû‡Ææ‡ÆØ‡Æø‡Æ±‡ØÅ" };

    const TITHI_NAMES = [
      "‡Æ™‡Æø‡Æ∞‡Æ§‡ÆÆ‡Øà","‡Æ§‡Øç‡Æµ‡Æø‡Æ§‡Æø‡ÆØ‡Øà","‡Æ§‡Æø‡Æ∞‡Æø‡Æ§‡Æø‡ÆØ‡Øà","‡Æö‡Æ§‡ØÅ‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡Æø","‡Æ™‡Æû‡Øç‡Æö‡ÆÆ‡Æø","‡Æ∑‡Æ∑‡Øç‡Æü‡Æø","‡Æö‡Æ™‡Øç‡Æ§‡ÆÆ‡Æø","‡ÆÖ‡Æ∑‡Øç‡Æü‡ÆÆ‡Æø","‡Æ®‡Æµ‡ÆÆ‡Æø","‡Æ§‡Æö‡ÆÆ‡Æø","‡Æè‡Æï‡Ææ‡Æ§‡Æö‡Æø","‡Æ§‡Øç‡Æµ‡Ææ‡Æ§‡Æö‡Æø","‡Æ§‡Æø‡Æ∞‡ÆØ‡Øã‡Æ§‡Æö‡Æø","‡Æö‡Æ§‡ØÅ‡Æ∞‡Øç‡Æ§‡Æö‡Æø","‡Æ™‡Øå‡Æ∞‡Øç‡Æ£‡ÆÆ‡Æø",
      "‡Æ™‡Æø‡Æ∞‡Æ§‡ÆÆ‡Øà","‡Æ§‡Øç‡Æµ‡Æø‡Æ§‡Æø‡ÆØ‡Øà","‡Æ§‡Æø‡Æ∞‡Æø‡Æ§‡Æø‡ÆØ‡Øà","‡Æö‡Æ§‡ØÅ‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡Æø","‡Æ™‡Æû‡Øç‡Æö‡ÆÆ‡Æø","‡Æ∑‡Æ∑‡Øç‡Æü‡Æø","‡Æö‡Æ™‡Øç‡Æ§‡ÆÆ‡Æø","‡ÆÖ‡Æ∑‡Øç‡Æü‡ÆÆ‡Æø","‡Æ®‡Æµ‡ÆÆ‡Æø","‡Æ§‡Æö‡ÆÆ‡Æø","‡Æè‡Æï‡Ææ‡Æ§‡Æö‡Æø","‡Æ§‡Øç‡Æµ‡Ææ‡Æ§‡Æö‡Æø","‡Æ§‡Æø‡Æ∞‡ÆØ‡Øã‡Æ§‡Æö‡Æø","‡Æö‡Æ§‡ØÅ‡Æ∞‡Øç‡Æ§‡Æö‡Æø","‡ÆÖ‡ÆÆ‡Ææ‡Æµ‡Ææ‡Æö‡Øà"
    ];

    const NAKSHATRA_NAMES = [
      "‡ÆÖ‡Æ∏‡Øç‡Æµ‡Æø‡Æ©‡Æø","‡Æ™‡Æ∞‡Æ£‡Æø","‡Æï‡Æø‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡Æø‡Æï‡Øà","‡Æ∞‡Øã‡Æπ‡Æø‡Æ£‡Æø","‡ÆÆ‡Æø‡Æ∞‡ØÅ‡Æï‡Æö‡ØÄ‡Æ∞‡Æø‡Æü‡ÆÆ‡Øç","‡Æ§‡Æø‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æ§‡Æø‡Æ∞‡Øà","‡Æ™‡ØÅ‡Æ©‡Æ∞‡Øç‡Æ™‡ØÇ‡Æö‡ÆÆ‡Øç","‡Æ™‡ØÇ‡Æö‡ÆÆ‡Øç","‡ÆÜ‡ÆØ‡Æø‡Æ≤‡Øç‡ÆØ‡ÆÆ‡Øç",
      "‡ÆÆ‡Æï‡ÆÆ‡Øç","‡Æ™‡ØÇ‡Æ∞‡ÆÆ‡Øç","‡Æâ‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡ÆÆ‡Øç","‡Æπ‡Æ∏‡Øç‡Æ§‡ÆÆ‡Øç","‡Æö‡Æø‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Øà","‡Æö‡ØÅ‡Æµ‡Ææ‡Æ§‡Æø","‡Æµ‡Æø‡Æö‡Ææ‡Æï‡ÆÆ‡Øç","‡ÆÖ‡Æ©‡ØÅ‡Æ∑‡ÆÆ‡Øç","‡Æï‡Øá‡Æü‡Øç‡Æü‡Øà",
      "‡ÆÆ‡ØÇ‡Æ≤‡ÆÆ‡Øç","‡Æ™‡ØÇ‡Æ∞‡Ææ‡Æü‡ÆÆ‡Øç","‡Æâ‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Ææ‡Æü‡ÆÆ‡Øç","‡Æ§‡Æø‡Æ∞‡ØÅ‡Æµ‡Øã‡Æ£‡ÆÆ‡Øç","‡ÆÖ‡Æµ‡Æø‡Æü‡Øç‡Æü‡ÆÆ‡Øç","‡Æö‡Æ§‡ÆØ‡ÆÆ‡Øç","‡Æ™‡ØÇ‡Æ∞‡Æü‡Øç‡Æü‡Ææ‡Æ§‡Æø","‡Æâ‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Æü‡Øç‡Æü‡Ææ‡Æ§‡Æø","‡Æ∞‡Øá‡Æµ‡Æ§‡Æø"
    ];

    // Sirupozhuthu rules
    const SIRUPOZHUTHU = [
      { name:"‡Æµ‡Øà‡Æï‡Æ±‡Øà",  start:2,  end:6  },
      { name:"‡Æï‡Ææ‡Æ≤‡Øà",    start:6,  end:10 },
      { name:"‡Æ®‡Æ£‡Øç‡Æ™‡Æï‡Æ≤‡Øç",  start:10, end:14 },
      { name:"‡Æè‡Æ±‡Øç‡Æ™‡Ææ‡Æü‡ØÅ",  start:14, end:18 },
      { name:"‡ÆÆ‡Ææ‡Æ≤‡Øà",    start:18, end:22 },
      { name:"‡ÆØ‡Ææ‡ÆÆ‡ÆÆ‡Øç",   start:22, end:26 } // 26 means next day 02
    ];
    function sirupozhuthuOf(dtCity){
      const h = dtCity.hour + dtCity.minute/60;
      for(const s of SIRUPOZHUTHU){
        const st = s.start;
        const en = s.end;
        if(en <= 24){
          if(h >= st && h < en) return s.name;
        }else{
          // crosses midnight (22 - 26)
          if(h >= st || h < (en - 24)) return s.name;
        }
      }
      return "‚Äî";
    }

    const el = (id) => document.getElementById(id);

    const cityTitle = el("cityTitle");
    const cityTzEl = el("cityTz");
    const shareStamp = el("shareStamp");
    const selectedStamp = el("selectedStamp");

    const cityInput = el("cityInput");
    const cityGo = el("cityGo");
    const dtInput = el("dtInput");

    const errBox = el("errBox");
    const infoBox = el("infoBox");

    const outYearBoth = el("outYearBoth");
    const outSeason = el("outSeason");
    const outMonth = el("outMonth");
    const outNakshatra = el("outNakshatra");
    const outPaksha = el("outPaksha");
    const outTithi = el("outTithi");
    const outDayNum = el("outDayNum");
    const outWeekday = el("outWeekday");
    const outSirupozhuthu = el("outSirupozhuthu");
    const outDayNight = el("outDayNight");
    const outSaamamNo = el("outSaamamNo");
    const outNaz = el("outNaz");
    const outVinadi = el("outVinadi");

    const footNote = el("footNote");

    const btnNow = el("btnNow");
    const btnRefresh = el("btnRefresh");
    const btnShare = el("btnShare");

    const state = {
      deviceTz: Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC",
      city: DEFAULT_CITY,
      cityTz: null,
      lat: null,
      lon: null,
      sunMap: new Map()
    };

    function clearError(){ errBox.style.display="none"; errBox.textContent=""; }
    function showError(title, details){
      errBox.style.display="block";
      errBox.textContent = `Error: ${title}${details ? " ¬∑ " + compactErr(details) : ""}`;
    }

    function effectiveTz(){ return state.cityTz || state.deviceTz; }

    function setDtInputNow(){
      const now = DateTime.now().setZone(effectiveTz());
      dtInput.value = `${now.toFormat("yyyy-LL-dd")}T${now.toFormat("HH:mm")}`;
    }

    function getSelectedDateTime(){
      const tz = effectiveTz();
      if(!dtInput.value) return DateTime.now().setZone(tz);
      return DateTime.fromISO(dtInput.value, { zone: tz });
    }

    function tamilMonthFromDate(localDate){
      const y = localDate.year;
      const zone = localDate.zoneName;
      const candidates = TAMIL_MONTHS.map(m => ({
        ...m,
        startDT: DateTime.fromObject({ year:y, month:m.start.m, day:m.start.d }, { zone }).startOf("day")
      }));
      let best = null;
      for(const c of candidates){
        if(c.startDT <= localDate && (!best || c.startDT > best.startDT)) best = c;
      }
      if(best) return best;
      const prevYear = y - 1;
      const panguni = TAMIL_MONTHS.find(m => m.name === "‡Æ™‡Æô‡Øç‡Æï‡ØÅ‡Æ©‡Æø");
      return {
        ...panguni,
        startDT: DateTime.fromObject({ year:prevYear, month:panguni.start.m, day:panguni.start.d }, { zone }).startOf("day")
      };
    }

    function tamilDayNumber(localDate, monthInfo){
      return Math.floor(localDate.startOf("day").diff(monthInfo.startDT, "days").days) + 1;
    }

    // Map to your provided year list using a 60-year cycle index (anchored to 1987-04-14)
    function tamilYearIndex(localDate){
      const zone = localDate.zoneName;
      const y = localDate.year;
      const boundaryThis = DateTime.fromObject({ year:y, month:4, day:14 }, { zone }).startOf("day");
      const start = (localDate >= boundaryThis)
        ? boundaryThis
        : DateTime.fromObject({ year:y-1, month:4, day:14 }, { zone }).startOf("day");

      const base = DateTime.fromObject({ year:1987, month:4, day:14 }, { zone:"Asia/Kolkata" }).startOf("day");
      const yearsSince = Math.floor(start.toUTC().diff(base.toUTC(), "years").years + 1e-9);
      const idx0 = ((yearsSince % 60) + 60) % 60; // 0..59
      return idx0 + 1; // 1..60
    }

    function tamilYearBoth(localDate){
      const idx = tamilYearIndex(localDate); // 1..60
      const entry = TAMIL_YEAR_LIST[idx-1];
      if(!entry) return { name:"‚Äî", meaning:"‚Äî", idx };
      return { name: entry.name, meaning: entry.meaning, idx };
    }

    // Panchang approx
    function julianDay(dtUtc){
      const y = dtUtc.year;
      const m = dtUtc.month;
      const D = dtUtc.day + (dtUtc.hour + (dtUtc.minute + dtUtc.second/60)/60)/24;
      let Y = y, M = m;
      if(M <= 2){ Y -= 1; M += 12; }
      const A = Math.floor(Y/100);
      const B = 2 - A + Math.floor(A/4);
      return Math.floor(365.25*(Y + 4716)) + Math.floor(30.6001*(M + 1)) + D + B - 1524.5;
    }
    function fixAngle(d){ d%=360; if(d<0) d+=360; return d; }
    function sunEclLon(jd){
      const T = (jd - 2451545.0) / 36525.0;
      const L0 = fixAngle(280.46646 + 36000.76983*T + 0.0003032*T*T);
      const M  = fixAngle(357.52911 + 35999.05029*T - 0.0001537*T*T);
      const Mr = M * Math.PI/180;
      const C = (1.914602 - 0.004817*T - 0.000014*T*T)*Math.sin(Mr)
              + (0.019993 - 0.000101*T)*Math.sin(2*Mr)
              + 0.000289*Math.sin(3*Mr);
      return fixAngle(L0 + C);
    }
    function moonEclLon(jd){
      const T = (jd - 2451545.0) / 36525.0;
      const L0 = fixAngle(218.3164477 + 481267.88123421*T);
      const D  = fixAngle(297.8501921 + 445267.1114034*T);
      const M  = fixAngle(357.5291092 + 35999.0502909*T);
      const Mp = fixAngle(134.9633964 + 477198.8675055*T);
      const Dr  = D  * Math.PI/180;
      const Mr  = M  * Math.PI/180;
      const Mpr = Mp * Math.PI/180;
      let lon = L0
        + 6.289 * Math.sin(Mpr)
        + 1.274 * Math.sin(2*Dr - Mpr)
        + 0.658 * Math.sin(2*Dr)
        - 0.186 * Math.sin(Mr)
        + 0.214 * Math.sin(2*Mpr);
      return fixAngle(lon);
    }
    function panchang(dtUtc){
      const jd = julianDay(dtUtc);
      const sunLon = sunEclLon(jd);
      const moonLon = moonEclLon(jd);
      const diff = fixAngle(moonLon - sunLon);
      const t = Math.floor(diff/12) + 1;
      const paksha = (t <= 15) ? "‡Æµ‡Æ≥‡Æ∞‡Øç‡Æ™‡Æø‡Æ±‡Øà" : "‡Æ§‡Øá‡ÆØ‡Øç‡Æ™‡Æø‡Æ±‡Øà";
      const tName = TITHI_NAMES[t-1] || "‚Äî";
      const n = Math.floor(fixAngle(moonLon) / (360/27)) + 1;
      const nName = NAKSHATRA_NAMES[n-1] || "‚Äî";
      return { paksha, tName, nName };
    }

    // APIs
    async function geocodeCity(name){
      const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=5&language=en&format=json`;
      const r = await fetch(url, { cache:"no-cache" });
      if(!r.ok) throw new Error(`Geocoding ${r.status}`);
      const j = await r.json();
      if(!j.results || !j.results.length) throw new Error("City not found");
      return j.results[0];
    }

    async function loadSun3Days(lat, lon, tz, dPrev, dNext){
      state.sunMap.clear();
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&daily=sunrise,sunset&timezone=${encodeURIComponent(tz)}&start_date=${dPrev}&end_date=${dNext}`;
      const r = await fetch(url, { cache:"no-cache" });
      if(!r.ok) throw new Error(`Sun ${r.status}`);
      const j = await r.json();
      if(!j.daily || !j.daily.time) throw new Error("Sun data missing");
      for(let i=0;i<j.daily.time.length;i++){
        const d = j.daily.time[i];
        const sunrise = j.daily.sunrise?.[i];
        const sunset  = j.daily.sunset?.[i];
        if(sunrise && sunset) state.sunMap.set(d, { sunrise, sunset });
      }
    }

    function getSun(dateISO){ return state.sunMap.get(dateISO) || null; }

    function lastSunriseBefore(dtCity){
      const d0 = dtCity.toISODate();
      const dPrev = dtCity.minus({ days:1 }).toISODate();
      const s0 = getSun(d0);
      const sp = getSun(dPrev);
      if(!s0 || !sp) return null;
      const sr0 = DateTime.fromISO(s0.sunrise, { zone: dtCity.zoneName });
      const srp = DateTime.fromISO(sp.sunrise, { zone: dtCity.zoneName });
      return (dtCity >= sr0) ? sr0 : srp;
    }

    function isDay(dtCity, sun){
      const sr = DateTime.fromISO(sun.sunrise, { zone: dtCity.zoneName });
      const ss = DateTime.fromISO(sun.sunset,  { zone: dtCity.zoneName });
      return (dtCity >= sr && dtCity < ss);
    }

    function tamilTime(dtCity, lastSunrise){
      const diffMin = dtCity.diff(lastSunrise, "minutes").minutes;
      const totalMin = ((diffMin % 1440) + 1440) % 1440;
      const nazhigai = Math.floor(totalMin/24) + 1;
      const saamam = Math.floor(totalMin/180) + 1;
      return { nazhigai, saamam, vinadi: dtCity.second };
    }

    function disclaimerText(){
      return [
        "DISCLAIMER",
        "- Tamil month/day/year: simple approximate boundary table.",
        "- Tamil varudam index: 60-year cycle (anchored to 1987-04-14 as baseline).",
        "- Tithi/Nakshatra/Paksha: approximate sun/moon longitudes.",
        "- Sirupozhuthu: fixed 2‚Äì6 / 6‚Äì10 / 10‚Äì2 / 2‚Äì6 / 6‚Äì10 / 10‚Äì2 mapping.",
        "- Sunrise/Sunset: Open-Meteo API (used for day/night + last-sunrise cycle).",
        "",
        "DEPENDENCIES",
        "1) https://geocoding-api.open-meteo.com/",
        "2) https://api.open-meteo.com/",
        "3) https://cdn.jsdelivr.net/",
        "4) https://fonts.googleapis.com/"
      ].join("\\n");
    }

    async function recalcAndRender(){
      clearError();

      const tz = effectiveTz();
      cityTitle.textContent = state.city || DEFAULT_CITY;
      cityTzEl.textContent = state.cityTz || "‚Äî";

      const dtCity = getSelectedDateTime().setZone(tz);
      const dtUtc = dtCity.toUTC();

      const d0 = dtCity.toISODate();
      const dPrev = dtCity.minus({ days:1 }).toISODate();
      const dNext = dtCity.plus({ days:1 }).toISODate();

      const stamp = dtCity.toFormat("dd LLL yyyy, hh:mm a");
      selectedStamp.textContent = stamp;

      // Share output: city + selected time; plus Sirupozhuthu shown as a visible row (so captured)
      shareStamp.textContent = `${state.city || DEFAULT_CITY} ¬∑ ${stamp}`;

      if(state.lat != null && state.lon != null){
        try{
          await loadSun3Days(state.lat, state.lon, tz, dPrev, dNext);
        }catch(e){
          showError("Sunrise/Sunset API failure", e.message);
        }
      }

      const mInfo = tamilMonthFromDate(dtCity);
      const dayNo = tamilDayNumber(dtCity, mInfo);
      const weekday = WEEKDAY_TA[dtCity.weekday] || "‚Äî";
      const pan = panchang(dtUtc);

      const yb = tamilYearBoth(dtCity);
      // Display both: "‡Æ™‡Æø‡Æ∞‡Æ™‡Æµ (01) ‚Äî ‡Æ®‡Æ±‡Øç‡Æ±‡Øã‡Æ©‡Øç‡Æ±‡Æ≤‡Øç"
      outYearBoth.textContent = `${yb.name} (${String(yb.idx).padStart(2,"0")}) ‚Äî ${yb.meaning}`;

      outSeason.textContent = mInfo.season;
      outMonth.textContent = mInfo.name;
      outNakshatra.textContent = pan.nName;
      outPaksha.textContent = pan.paksha;
      outTithi.textContent = pan.tName;
      outDayNum.textContent = dayNo;
      outWeekday.textContent = weekday;

      outSirupozhuthu.textContent = sirupozhuthuOf(dtCity);

      const sun = getSun(d0);
      if(sun){
        outDayNight.textContent = isDay(dtCity, sun) ? "‡Æ™‡Æï‡Æ≤‡Øç" : "‡Æá‡Æ∞‡Æµ‡ØÅ";

        const ls = lastSunriseBefore(dtCity);
        if(ls){
          const tt = tamilTime(dtCity, ls);
          outSaamamNo.textContent = tt.saamam;
          outNaz.textContent = tt.nazhigai;
          outVinadi.textContent = tt.vinadi;
        }else{
          outSaamamNo.textContent = "‚Äî";
          outNaz.textContent = "‚Äî";
          outVinadi.textContent = dtCity.second;
        }
      }else{
        outDayNight.textContent = "‚Äî";
        outSaamamNo.textContent = "‚Äî";
        outNaz.textContent = "‚Äî";
        outVinadi.textContent = dtCity.second;
      }

      footNote.textContent = APP_NAME;
      infoBox.textContent = disclaimerText();
    }

    async function setCity(cityName, { resetToNow=false } = {}){
      clearError();
      const q = (cityName || "").trim();
      if(!q) return;

      cityGo.disabled = true;
      cityGo.textContent = "Loading‚Ä¶";

      try{
        const best = await geocodeCity(q);
        state.city = [best.name, best.admin1].filter(Boolean).join(", ");
        state.lat = best.latitude;
        state.lon = best.longitude;
        state.cityTz = best.timezone || null;

        cityTitle.textContent = state.city;
        cityTzEl.textContent = state.cityTz || "‚Äî";

        if(resetToNow) setDtInputNow();
        await recalcAndRender();
      }catch(e){
        showError("Geocoding API failure", e.message);
      }finally{
        cityGo.disabled = false;
        cityGo.textContent = "Search";
      }
    }

    async function shareScreenshot(){
      clearError();
      const shareArea = document.getElementById("shareArea");

      document.body.classList.add("sharing");
      await new Promise(r => setTimeout(r, 80));

      try{
        const canvas = await html2canvas(shareArea, {
          backgroundColor: "#070a10",
          scale: Math.min(2, window.devicePixelRatio || 1),
          useCORS: true
        });

        const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png", 0.95));
        if(!blob) throw new Error("Screenshot failed");

        const tz = effectiveTz();
        const dtCity = getSelectedDateTime().setZone(tz);
        const safeName = `${APP_NAME}-${(state.city||DEFAULT_CITY)}-${dtCity.toFormat("yyyyLLdd-HHmm")}`
          .replace(/[^\\w\\u0B80-\\u0BFF\\-]+/g, "_");

        const file = new File([blob], `${safeName}.png`, { type: "image/png" });

        if(navigator.canShare && navigator.canShare({ files: [file] })){
          await navigator.share({ title: APP_NAME, text: APP_NAME, files: [file] });
        } else {
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = `${safeName}.png`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(a.href);
        }
      }catch(e){
        showError("Share failed", e.message);
      }finally{
        document.body.classList.remove("sharing");
      }
    }

    // Hooks
    document.getElementById("cityGo").addEventListener("click", () => setCity(cityInput.value, { resetToNow:true }));
    cityInput.addEventListener("keydown", (e) => { if(e.key === "Enter") setCity(cityInput.value, { resetToNow:true }); });

    document.getElementById("btnNow").addEventListener("click", async () => { setDtInputNow(); await recalcAndRender(); });
    document.getElementById("btnRefresh").addEventListener("click", () => recalcAndRender().catch(e => showError("Recalc failed", e.message)));
    document.getElementById("btnShare").addEventListener("click", () => shareScreenshot());

    dtInput.addEventListener("change", () => recalcAndRender().catch(e => showError("Recalc failed", e.message)));

    // Init
    (async function init(){
      document.title = APP_NAME;
      cityInput.value = DEFAULT_CITY;
      infoBox.textContent = disclaimerText();

      await setCity(DEFAULT_CITY, { resetToNow:true });

      if(state.lat == null || state.lon == null){
        state.city = DEFAULT_CITY;
        cityTitle.textContent = DEFAULT_CITY;
        state.cityTz = state.deviceTz;
        cityTzEl.textContent = state.cityTz;
        setDtInputNow();
        await recalcAndRender();
      }
    })();
  </script>
</body>
</html>
