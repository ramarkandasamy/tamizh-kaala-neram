<!doctype html>
<html lang="ta">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <meta name="color-scheme" content="dark light" />
  <title>родрооро┐ро┤рпН роХро╛ро▓ роирпЗро░роорпН</title>

  <!-- author info ONLY in HTML (not displayed) -->
  <meta name="author" content="Ramar Kandasamy">
  <meta name="email" content="ram.kabil@gmailcom">
  <meta name="application-name" content="родрооро┐ро┤рпН роХро╛ро▓ роирпЗро░роорпН">
  <meta name="apple-mobile-web-app-title" content="родрооро┐ро┤рпН роХро╛ро▓ роирпЗро░роорпН">
  <meta name="description" content="родрооро┐ро┤рпН роХро╛ро▓ роирпЗро░роорпН тАФ роиро╛ро┤ро┐роХрпИ / роЪро╛роороорпН / рокроЮрпНроЪро╛роЩрпНроХроорпН.">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Tiro+Tamil:ital,wght@0,400;1,400&display=swap" rel="stylesheet">

  <!-- Luxon -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <!-- html2canvas (share screenshot) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#070a10;
      --stroke:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --r:20px;
      --card:rgba(255,255,255,.055); /* solid (no gradient) to avoid banding */
      --card2:rgba(0,0,0,.22);
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      background: var(--bg);
      color:var(--text);
      font-family:"Tiro Tamil", serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-x:hidden;
    }

    /* FIX: background gradients are drawn in fixed pseudo-layers so they never "break" mid-page */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      background:
        radial-gradient(1100px 650px at 12% 0%, rgba(120,180,255,.16), transparent 60%),
        radial-gradient(950px 600px at 92% 25%, rgba(255,160,210,.12), transparent 55%),
        radial-gradient(1100px 700px at 50% 100%, rgba(160,255,210,.08), transparent 62%);
      transform: translateZ(0);
    }
    body::after{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      opacity:.035;
      background-image:
        repeating-linear-gradient(-25deg,
          rgba(255,255,255,.22) 0px,
          rgba(255,255,255,.22) 1px,
          transparent 1px,
          transparent 26px
        );
      transform: translateZ(0);
    }

    .wrap{
      position:relative;
      z-index:1;
      max-width:760px;
      margin:0 auto;
      padding:22px 14px 40px;
    }

    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;}
    .brand{display:flex;align-items:center;gap:10px;min-width:0;}
    .logo{
      width:38px;height:38px;border-radius:14px;
      background:linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.05));
      border:1px solid var(--stroke);
      box-shadow:0 10px 28px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .title{min-width:0;line-height:1.15;}
    .title .h{font-size:18px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .title .sub{
      font-size:12px;color:var(--muted);
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }

    .actions{display:flex;gap:10px;align-items:center;}
    .iconbtn{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.07);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      display:inline-flex;align-items:center;gap:8px;
      cursor:pointer;
      box-shadow:0 10px 30px rgba(0,0,0,.22);
      transition:transform .12s ease, background .12s ease;
      user-select:none;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
      white-space:nowrap;
    }
    .iconbtn:hover{background:rgba(255,255,255,.10);}
    .iconbtn:active{transform:scale(.98);}

    .card{
      background: var(--card); /* solid */
      border:1px solid var(--stroke);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    .pad{padding:14px;}
    .grid2{display:grid;grid-template-columns:1fr auto;gap:10px;margin-bottom:10px;}
    .gridPick{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:6px;}

    .input{
      width:100%;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: var(--card2);
      color:var(--text);
      padding:12px 14px;
      outline:none;
      font-size:16px;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
    }
    .btn{
      border-radius:16px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.10);
      color:var(--text);
      padding:12px 14px;
      font-size:15px;cursor:pointer;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(255,255,255,.13);}
    .btn:active{transform:scale(.98);}

    .helper{
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      font-size:12px;color:var(--muted);
      margin:6px 2px 2px;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
    }

    /* CLEAN LIST (consistent pattern all rows) */
    .list{
      border-top:1px solid rgba(255,255,255,.07);
      padding:6px 16px 10px;
      background: rgba(0,0,0,.08); /* subtle uniform fill to prevent banding */
    }
    .row{
      display:flex;justify-content:space-between;gap:14px;
      padding:11px 0;
      border-bottom:1px solid rgba(255,255,255,.06);
      align-items:baseline;
    }
    .row:last-child{border-bottom:0;}
    .k{color:var(--muted);font-size:16px;flex:0 0 auto;}
    .v{text-align:right;font-size:20px;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .big{font-size:24px;}
    .num{font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;font-variant-numeric:tabular-nums;}
    .range{font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;}
    .dash{opacity:.55;padding:0 8px;}

    .err{
      display:none;
      margin-top:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,120,120,.22);
      background:rgba(255,80,80,.08);
      color:rgba(255,210,210,.92);
      font-size:13px;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
      white-space:pre-wrap;
    }

    details{border-top:1px solid rgba(255,255,255,.07);padding:10px 16px 14px;}
    summary{
      list-style:none;cursor:pointer;
      display:flex;justify-content:space-between;gap:10px;
      color:var(--muted);
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
      user-select:none;padding:8px 0;
    }
    summary::-webkit-details-marker{display:none;}
    .infobox{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.26);
      border-radius:16px;
      padding:12px;
      color:rgba(255,255,255,.80);
      font-size:13px;line-height:1.55;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
      white-space:pre-wrap;
    }

    .footer{
      margin-top:14px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
    }
    .donate{
      text-decoration:none;
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.08);
      color:var(--text);
    }

    /* Share mode: hide controls/details/footer only */
    body.sharing .no-share{display:none !important;}
    body.sharing details{display:none !important;}
    body.sharing .footer{display:none !important;}

    /* Share-only stamp */
    .shareStamp{
      display:none;
      margin: 10px 0 0;
      padding: 10px 16px 0;
      color: rgba(255,255,255,.86);
      font-size: 14px;
      font-family:"Roboto",system-ui,-apple-system,Segoe UI,sans-serif;
    }
    body.sharing .shareStamp{display:block;}

    @media(max-width:520px){
      .v{font-size:19px;}
      .big{font-size:22px;}
    }
  </style>
</head>

<body data-app="родрооро┐ро┤рпН роХро╛ро▓ роирпЗро░роорпН">
  <!-- AUTHOR STORED IN HTML ONLY (not shown): Ramar Kandasamy ┬╖ ram.kabil@gmailcom -->
  <div style="display:none">родрооро┐ро┤рпН роХро╛ро▓ роирпЗро░роорпН тАФ Author: Ramar Kandasamy тАФ Email: ram.kabil@gmailcom</div>

  <div class="wrap">
    <div id="shareArea">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="title">
            <div class="h" id="cityTitle">родрооро┐ро┤рпН роХро╛ро▓ роирпЗро░роорпН</div>
            <div class="sub">City TZ: <span id="cityTz">тАФ</span></div>
          </div>
        </div>

        <div class="actions no-share">
          <button class="iconbtn" id="btnShare" title="Share"><span aria-hidden="true">ЁЯУд</span><span class="num">Share</span></button>
          <button class="iconbtn" id="btnNow" title="Now"><span aria-hidden="true">тП▒я╕П</span><span class="num">Now</span></button>
          <button class="iconbtn" id="btnRefresh" title="Refresh"><span aria-hidden="true">тЖ╗</span><span class="num">Refresh</span></button>
        </div>
      </div>

      <!-- Share-only stamp: includes selected date/time -->
      <div class="shareStamp" id="shareStamp">тАФ</div>

      <div class="card">
        <div class="pad">
          <div class="grid2 no-share">
            <input id="cityInput" class="input" placeholder="City (e.g., Madurai, Chennai, Singapore)" />
            <button id="cityGo" class="btn">Search</button>
          </div>

          <div class="gridPick no-share">
            <input id="dtInput" class="input" type="datetime-local" />
          </div>

          <div class="helper no-share">
            <div>Selected: <span class="num" id="selectedStamp">тАФ</span></div>
          </div>

          <div class="err" id="errBox"></div>
        </div>

        <div class="list">
          <div class="row"><div class="k">роЖрогрпНроЯрпБ</div><div class="v" id="outYear">тАФ</div></div>
          <div class="row"><div class="k">рокро░рпБро╡роорпН</div><div class="v" id="outSeason">тАФ</div></div>
          <div class="row"><div class="k">рооро╛родроорпН</div><div class="v" id="outMonth">тАФ</div></div>
          <div class="row"><div class="k">роироЯрпНроЪродрпНродро┐ро░роорпН</div><div class="v" id="outNakshatra">тАФ</div></div>
          <div class="row"><div class="k">ро╡ро│ро░рпНрокро┐ро▒рпИ / родрпЗропрпНрокро┐ро▒рпИ</div><div class="v" id="outPaksha">тАФ</div></div>
          <div class="row"><div class="k">родро┐родро┐</div><div class="v" id="outTithi">тАФ</div></div>
          <div class="row"><div class="k">родрпЗродро┐</div><div class="v"><span class="num" id="outDayNum">тАФ</span></div></div>
          <div class="row"><div class="k">роХро┐ро┤роорпИ</div><div class="v" id="outWeekday">тАФ</div></div>

          <div class="row"><div class="k">рокроХро▓рпН / роЗро░ро╡рпБ</div><div class="v big" id="outDayNight">тАФ</div></div>
          <div class="row"><div class="k">роЪро╛роороорпН</div><div class="v"><span class="num" id="outSaamamNo">тАФ</span> / <span class="num">8</span></div></div>
          <div class="row"><div class="k">роиро╛ро┤ро┐роХрпИ</div><div class="v"><span class="num" id="outNaz">тАФ</span> / <span class="num">60</span></div></div>
          <div class="row"><div class="k">роиро┐рооро┐роЯроорпН</div><div class="v"><span class="num" id="outMin">тАФ</span></div></div>
          <div class="row"><div class="k">ро╡ро┐ройро╛роЯро┐</div><div class="v"><span class="num" id="outVinadi">тАФ</span></div></div>

          <div class="row">
            <div class="k">ро░ро╛роХрпБ роХро╛ро▓роорпН</div>
            <div class="v range"><span class="num" id="outRahuStart">тАФ</span><span class="dash">тАФ</span><span class="num" id="outRahuEnd">тАФ</span></div>
          </div>
          <div class="row">
            <div class="k">ропроороХрогрпНроЯроорпН</div>
            <div class="v range"><span class="num" id="outYamaStart">тАФ</span><span class="dash">тАФ</span><span class="num" id="outYamaEnd">тАФ</span></div>
          </div>
          <div class="row">
            <div class="k">роХрпБро│ро┐роХрпИ</div>
            <div class="v range"><span class="num" id="outGulikaStart">тАФ</span><span class="dash">тАФ</span><span class="num" id="outGulikaEnd">тАФ</span></div>
          </div>
        </div>

        <details class="no-share">
          <summary><span>Info ┬╖ Disclaimer ┬╖ Dependencies</span><span aria-hidden="true">тЦ╛</span></summary>
          <div class="infobox" id="infoBox">тАФ</div>
        </details>
      </div>
    </div>

    <div class="footer no-share">
      <a class="donate" href="upi://pay?pa=8903448384@upi&pn=Ramar%20Kandasamy&cu=INR"><span aria-hidden="true">тЭдя╕П</span> Donate <span class="num">UPI</span></a>
      <div class="num" id="footNote">родрооро┐ро┤рпН роХро╛ро▓ роирпЗро░роорпН</div>
    </div>
  </div>

  <script>
    const { DateTime } = luxon;

    // Compact errors only
    function compactErr(msg){
      const s = String(msg || "").slice(0, 180);
      return s.replace(/\s+/g, " ").trim();
    }
    window.addEventListener("error", (e) => {
      const box = document.getElementById("errBox");
      if(!box) return;
      box.style.display = "block";
      box.textContent = `Error: ${compactErr(e.message)}`;
    });

    const APP_NAME = "родрооро┐ро┤рпН роХро╛ро▓ роирпЗро░роорпН";
    const DEFAULT_CITY = "Madurai";

    const TAMIL_MONTHS = [
      { name: "роЪро┐родрпНродро┐ро░рпИ",   start: { m: 4,  d: 14 }, season: "роЗро│ро╡рпЗройро┐ро▓рпН" },
      { name: "ро╡рпИроХро╛роЪро┐",    start: { m: 5,  d: 15 }, season: "роЗро│ро╡рпЗройро┐ро▓рпН" },
      { name: "роЖройро┐",       start: { m: 6,  d: 15 }, season: "роорпБродрпБро╡рпЗройро┐ро▓рпН" },
      { name: "роЖроЯро┐",       start: { m: 7,  d: 16 }, season: "роорпБродрпБро╡рпЗройро┐ро▓рпН" },
      { name: "роЖро╡рогро┐",     start: { m: 8,  d: 16 }, season: "роХро╛ро░рпН" },
      { name: "рокрпБро░роЯрпНроЯро╛роЪро┐", start: { m: 9,  d: 16 }, season: "роХро╛ро░рпН" },
      { name: "роРрокрпНрокроЪро┐",    start: { m: 10, d: 17 }, season: "роХрпВродро┐ро░рпН" },
      { name: "роХро╛ро░рпНродрпНродро┐роХрпИ",start: { m: 11, d: 16 }, season: "роХрпВродро┐ро░рпН" },
      { name: "рооро╛ро░рпНроХро┤ро┐",   start: { m: 12, d: 16 }, season: "роорпБройрпНрокройро┐" },
      { name: "родрпИ",        start: { m: 1,  d: 14 }, season: "роорпБройрпНрокройро┐" },
      { name: "рооро╛роЪро┐",      start: { m: 2,  d: 13 }, season: "рокро┐ройрпНрокройро┐" },
      { name: "рокроЩрпНроХрпБройро┐",   start: { m: 3,  d: 14 }, season: "рокро┐ройрпНрокройро┐" }
    ];

    const TAMIL_YEAR_NAMES = [
      "рокро┐ро░рокро╡","ро╡ро┐рокро╡","роЪрпБроХрпНро▓","рокро┐ро░роорпЛродрпВрод","рокро┐ро░роЬрпЛро▒рпНрокродрпНродро┐","роЖроЩрпНроХрпАро░роЪ",
      "ро╕рпНро░рпАроорпБроХ","рокро╛ро╡","ропрпБро╡","родро╛родрпБ","роИро╕рпНро╡ро░","ро╡рпЖроХрпБродро╛ройрпНроп",
      "рокро┐ро░рооро╛родро┐","ро╡ро┐роХрпНро░роо","ро╡ро┐ро╖рпБ","роЪро┐родрпНродро┐ро░рокро╛ройрпБ","роЪрпБрокро╛ройрпБ","родро╛ро░рог",
      "рокро╛ро░рпНродрпНродро┐рок","ро╡ро┐роп","роЪро░рпНро╡роЬро┐родрпН","роЪро░рпНро╡родро╛ро░ро┐","ро╡ро┐ро░рпЛродро┐","ро╡ро┐роХрпНро░рпБродро┐",
      "роХро░","роироирпНродрой","ро╡ро┐роЬроп","роЬроп","рооройрпНроород","родрпБро░рпНроорпБроХро┐",
      "ро╣рпЗро╡ро┐ро│роорпНрокро┐","ро╡ро┐ро│роорпНрокро┐","ро╡ро┐роХро╛ро░ро┐","роЪро╛ро░рпНро╡ро░ро┐","рокро┐ро▓ро╡","роЪрпБрокроХро┐ро░рпБродрпБ",
      "роЪрпЛрокроХро┐ро░рпБродрпБ","роХрпБро░рпЛродро┐","ро╡ро┐роЪрпБро╡ро╛роЪрпБ","рокро░ро╛рокро╡","рокро┐ро▓ро╡роЩрпНроХ",
      "роХрпАро▓роХ","роЪрпМроорпНроп","роЪро╛родро╛ро░рог","ро╡ро┐ро░рпЛродро┐роХро┐ро░рпБродрпБ","рокро░ро┐родро╛рокро┐",
      "рокро┐ро░рооро╛родрпАроЪ","роЖройроирпНрод","ро░ро╛роХрпНро╖роЪ","роиро│","рокро┐роЩрпНроХро│","роХро╛ро│ропрпБроХрпНродро┐",
      "роЪро┐родрпНродро╛ро░рпНродрпНродро┐","ро░рпМродрпНро░ро┐","родрпБройрпНроородро┐","родрпБроирпНродрпБрокро┐","ро░рпБродрпНро░рпЛродрпНроХро╛ро░ро┐",
      "ро░роХрпНродро╛роЯрпНроЪро┐","роХрпНро░рпЛродрой","роЕроХрпНро╖роп"
    ];

    const WEEKDAY_TA = { 1:"родро┐роЩрпНроХро│рпН",2:"роЪрпЖро╡рпНро╡ро╛ропрпН",3:"рокрпБродройрпН",4:"ро╡ро┐ропро╛ро┤ройрпН",5:"ро╡рпЖро│рпНро│ро┐",6:"роЪройро┐",7:"роЮро╛ропро┐ро▒рпБ" };

    const TITHI_NAMES = [
      "рокро┐ро░родроорпИ","родрпНро╡ро┐родро┐ропрпИ","родро┐ро░ро┐родро┐ропрпИ","роЪродрпБро░рпНродрпНродро┐","рокроЮрпНроЪрооро┐","ро╖ро╖рпНроЯро┐","роЪрокрпНродрооро┐","роЕро╖рпНроЯрооро┐","роиро╡рооро┐","родроЪрооро┐","роПроХро╛родроЪро┐","родрпНро╡ро╛родроЪро┐","родро┐ро░ропрпЛродроЪро┐","роЪродрпБро░рпНродроЪро┐","рокрпМро░рпНрогрооро┐",
      "рокро┐ро░родроорпИ","родрпНро╡ро┐родро┐ропрпИ","родро┐ро░ро┐родро┐ропрпИ","роЪродрпБро░рпНродрпНродро┐","рокроЮрпНроЪрооро┐","ро╖ро╖рпНроЯро┐","роЪрокрпНродрооро┐","роЕро╖рпНроЯрооро┐","роиро╡рооро┐","родроЪрооро┐","роПроХро╛родроЪро┐","родрпНро╡ро╛родроЪро┐","родро┐ро░ропрпЛродроЪро┐","роЪродрпБро░рпНродроЪро┐","роЕрооро╛ро╡ро╛роЪрпИ"
    ];

    const NAKSHATRA_NAMES = [
      "роЕро╕рпНро╡ро┐ройро┐","рокро░рогро┐","роХро┐ро░рпБродрпНродро┐роХрпИ","ро░рпЛро╣ро┐рогро┐","рооро┐ро░рпБроХроЪрпАро░ро┐роЯроорпН","родро┐ро░рпБро╡ро╛родро┐ро░рпИ","рокрпБройро░рпНрокрпВроЪроорпН","рокрпВроЪроорпН","роЖропро┐ро▓рпНропроорпН",
      "роороХроорпН","рокрпВро░роорпН","роЙродрпНродро┐ро░роорпН","ро╣ро╕рпНродроорпН","роЪро┐родрпНродро┐ро░рпИ","роЪрпБро╡ро╛родро┐","ро╡ро┐роЪро╛роХроорпН","роЕройрпБро╖роорпН","роХрпЗроЯрпНроЯрпИ",
      "роорпВро▓роорпН","рокрпВро░ро╛роЯроорпН","роЙродрпНродро┐ро░ро╛роЯроорпН","родро┐ро░рпБро╡рпЛрогроорпН","роЕро╡ро┐роЯрпНроЯроорпН","роЪродропроорпН","рокрпВро░роЯрпНроЯро╛родро┐","роЙродрпНродро┐ро░роЯрпНроЯро╛родро┐","ро░рпЗро╡родро┐"
    ];

    const el = (id) => document.getElementById(id);

    const cityTitle = el("cityTitle");
    const cityTzEl = el("cityTz");
    const shareStamp = el("shareStamp");
    const selectedStamp = el("selectedStamp");

    const cityInput = el("cityInput");
    const cityGo = el("cityGo");
    const dtInput = el("dtInput");

    const errBox = el("errBox");
    const infoBox = el("infoBox");

    const outYear = el("outYear");
    const outSeason = el("outSeason");
    const outMonth = el("outMonth");
    const outNakshatra = el("outNakshatra");
    const outPaksha = el("outPaksha");
    const outTithi = el("outTithi");
    const outDayNum = el("outDayNum");
    const outWeekday = el("outWeekday");
    const outDayNight = el("outDayNight");
    const outSaamamNo = el("outSaamamNo");
    const outNaz = el("outNaz");
    const outMin = el("outMin");
    const outVinadi = el("outVinadi");

    const outRahuStart = el("outRahuStart");
    const outRahuEnd = el("outRahuEnd");
    const outYamaStart = el("outYamaStart");
    const outYamaEnd = el("outYamaEnd");
    const outGulikaStart = el("outGulikaStart");
    const outGulikaEnd = el("outGulikaEnd");

    const footNote = el("footNote");

    const btnNow = el("btnNow");
    const btnRefresh = el("btnRefresh");
    const btnShare = el("btnShare");

    const state = {
      deviceTz: Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC",
      city: DEFAULT_CITY,
      cityTz: null,
      lat: null,
      lon: null,
      sunMap: new Map() // 3-day cache
    };

    function clearError(){ errBox.style.display="none"; errBox.textContent=""; }
    function showError(title, details){
      errBox.style.display="block";
      errBox.textContent = `Error: ${title}${details ? " ┬╖ " + compactErr(details) : ""}`;
    }

    function effectiveTz(){ return state.cityTz || state.deviceTz; }

    function setDtInputNow(){
      const now = DateTime.now().setZone(effectiveTz());
      dtInput.value = `${now.toFormat("yyyy-LL-dd")}T${now.toFormat("HH:mm")}`;
    }

    function getSelectedDateTime(){
      const tz = effectiveTz();
      if(!dtInput.value) return DateTime.now().setZone(tz);
      return DateTime.fromISO(dtInput.value, { zone: tz });
    }

    function tamilMonthFromDate(localDate){
      const y = localDate.year;
      const zone = localDate.zoneName;
      const candidates = TAMIL_MONTHS.map(m => ({
        ...m,
        startDT: DateTime.fromObject({ year:y, month:m.start.m, day:m.start.d }, { zone }).startOf("day")
      }));
      let best = null;
      for(const c of candidates){
        if(c.startDT <= localDate && (!best || c.startDT > best.startDT)) best = c;
      }
      if(best) return best;
      const prevYear = y - 1;
      const panguni = TAMIL_MONTHS.find(m => m.name === "рокроЩрпНроХрпБройро┐");
      return {
        ...panguni,
        startDT: DateTime.fromObject({ year:prevYear, month:panguni.start.m, day:panguni.start.d }, { zone }).startOf("day")
      };
    }

    function tamilDayNumber(localDate, monthInfo){
      return Math.floor(localDate.startOf("day").diff(monthInfo.startDT, "days").days) + 1;
    }

    function tamilYearName(localDate){
      const zone = localDate.zoneName;
      const y = localDate.year;
      const boundaryThis = DateTime.fromObject({ year:y, month:4, day:14 }, { zone }).startOf("day");
      const start = (localDate >= boundaryThis)
        ? boundaryThis
        : DateTime.fromObject({ year:y-1, month:4, day:14 }, { zone }).startOf("day");

      const base = DateTime.fromObject({ year:1987, month:4, day:14 }, { zone:"Asia/Kolkata" }).startOf("day");
      const yearsSince = Math.floor(start.toUTC().diff(base.toUTC(), "years").years + 1e-9);
      const idx = ((yearsSince % 60) + 60) % 60;
      return TAMIL_YEAR_NAMES[idx] || "тАФ";
    }

    // Panchang (fast approx)
    function julianDay(dtUtc){
      const y = dtUtc.year;
      const m = dtUtc.month;
      const D = dtUtc.day + (dtUtc.hour + (dtUtc.minute + dtUtc.second/60)/60)/24;
      let Y = y, M = m;
      if(M <= 2){ Y -= 1; M += 12; }
      const A = Math.floor(Y/100);
      const B = 2 - A + Math.floor(A/4);
      return Math.floor(365.25*(Y + 4716)) + Math.floor(30.6001*(M + 1)) + D + B - 1524.5;
    }
    function fixAngle(d){ d%=360; if(d<0) d+=360; return d; }
    function sunEclLon(jd){
      const T = (jd - 2451545.0) / 36525.0;
      const L0 = fixAngle(280.46646 + 36000.76983*T + 0.0003032*T*T);
      const M  = fixAngle(357.52911 + 35999.05029*T - 0.0001537*T*T);
      const Mr = M * Math.PI/180;
      const C = (1.914602 - 0.004817*T - 0.000014*T*T)*Math.sin(Mr)
              + (0.019993 - 0.000101*T)*Math.sin(2*Mr)
              + 0.000289*Math.sin(3*Mr);
      return fixAngle(L0 + C);
    }
    function moonEclLon(jd){
      const T = (jd - 2451545.0) / 36525.0;
      const L0 = fixAngle(218.3164477 + 481267.88123421*T);
      const D  = fixAngle(297.8501921 + 445267.1114034*T);
      const M  = fixAngle(357.5291092 + 35999.0502909*T);
      const Mp = fixAngle(134.9633964 + 477198.8675055*T);
      const Dr  = D  * Math.PI/180;
      const Mr  = M  * Math.PI/180;
      const Mpr = Mp * Math.PI/180;
      let lon = L0
        + 6.289 * Math.sin(Mpr)
        + 1.274 * Math.sin(2*Dr - Mpr)
        + 0.658 * Math.sin(2*Dr)
        - 0.186 * Math.sin(Mr)
        + 0.214 * Math.sin(2*Mpr);
      return fixAngle(lon);
    }
    function panchang(dtUtc){
      const jd = julianDay(dtUtc);
      const sunLon = sunEclLon(jd);
      const moonLon = moonEclLon(jd);

      const diff = fixAngle(moonLon - sunLon);
      const t = Math.floor(diff/12) + 1; // 1..30
      const paksha = (t <= 15) ? "ро╡ро│ро░рпНрокро┐ро▒рпИ" : "родрпЗропрпНрокро┐ро▒рпИ";
      const tName = TITHI_NAMES[t-1] || "тАФ";

      const n = Math.floor(fixAngle(moonLon) / (360/27)) + 1;
      const nName = NAKSHATRA_NAMES[n-1] || "тАФ";

      return { paksha, tName, nName };
    }

    // APIs
    async function geocodeCity(name){
      const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=5&language=en&format=json`;
      const r = await fetch(url, { cache:"no-cache" });
      if(!r.ok) throw new Error(`Geocoding ${r.status}`);
      const j = await r.json();
      if(!j.results || !j.results.length) throw new Error("City not found");
      return j.results[0];
    }

    async function loadSun3Days(lat, lon, tz, dPrev, dNext){
      state.sunMap.clear();
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&daily=sunrise,sunset&timezone=${encodeURIComponent(tz)}&start_date=${dPrev}&end_date=${dNext}`;
      const r = await fetch(url, { cache:"no-cache" });
      if(!r.ok) throw new Error(`Sun ${r.status}`);
      const j = await r.json();
      if(!j.daily || !j.daily.time) throw new Error("Sun data missing");
      for(let i=0;i<j.daily.time.length;i++){
        const d = j.daily.time[i];
        const sunrise = j.daily.sunrise?.[i];
        const sunset  = j.daily.sunset?.[i];
        if(sunrise && sunset) state.sunMap.set(d, { sunrise, sunset });
      }
    }

    function getSun(dateISO){ return state.sunMap.get(dateISO) || null; }

    function lastSunriseBefore(dtCity){
      const d0 = dtCity.toISODate();
      const dPrev = dtCity.minus({ days:1 }).toISODate();
      const s0 = getSun(d0);
      const sp = getSun(dPrev);
      if(!s0 || !sp) return null;

      const sr0 = DateTime.fromISO(s0.sunrise, { zone: dtCity.zoneName });
      const srp = DateTime.fromISO(sp.sunrise, { zone: dtCity.zoneName });
      return (dtCity >= sr0) ? sr0 : srp;
    }

    function isDay(dtCity, sun){
      const sr = DateTime.fromISO(sun.sunrise, { zone: dtCity.zoneName });
      const ss = DateTime.fromISO(sun.sunset,  { zone: dtCity.zoneName });
      return (dtCity >= sr && dtCity < ss);
    }

    function tamilTime(dtCity, lastSunrise){
      const diffMin = dtCity.diff(lastSunrise, "minutes").minutes;
      const totalMin = ((diffMin % 1440) + 1440) % 1440;
      const nazhigai = Math.floor(totalMin/24) + 1;
      const minuteInNazhi = Math.floor(totalMin % 24);
      const saamam = Math.floor(totalMin/180) + 1;
      return { nazhigai, minuteInNazhi, saamam, vinadi: dtCity.second };
    }

    // Rahu/Yama/Gulika
    const RAHU_IDX = { 1:2, 2:7, 3:5, 4:6, 5:4, 6:3, 7:8 }; // Mon..Sun
    const YAMA_IDX = { 1:5, 2:4, 3:3, 4:2, 5:1, 6:7, 7:6 };
    const GULI_IDX = { 1:6, 2:5, 3:4, 4:3, 5:2, 6:1, 7:7 };

    function segmentWindow(dtCity, sun, whichIdx){
      const sr = DateTime.fromISO(sun.sunrise, { zone: dtCity.zoneName });
      const ss = DateTime.fromISO(sun.sunset,  { zone: dtCity.zoneName });
      const dayMin = ss.diff(sr, "minutes").minutes;
      if(!(dayMin > 0)) return null;
      const part = dayMin / 8;
      const start = sr.plus({ minutes: part * (whichIdx - 1) });
      const end   = sr.plus({ minutes: part * whichIdx });
      return { start, end };
    }
    function fmtTime(dt){ return dt ? dt.toFormat("hh:mm a") : "тАФ"; }

    function disclaimerText(){
      return [
        "DISCLAIMER",
        "- Tamil month/day/year: simple approximate boundary table.",
        "- Tithi/Nakshatra/Paksha: approximate sun/moon longitudes.",
        "- Sunrise/Sunset: Open-Meteo API (used for day/night + Rahu/Yama/Gulika + last-sunrise cycle).",
        "",
        "DEPENDENCIES",
        "1) https://geocoding-api.open-meteo.com/",
        "2) https://api.open-meteo.com/",
        "3) https://cdn.jsdelivr.net/",
        "4) https://fonts.googleapis.com/"
      ].join("\n");
    }

    async function recalcAndRender(){
      clearError();

      const tz = effectiveTz();
      cityTitle.textContent = state.city || DEFAULT_CITY;
      cityTzEl.textContent = state.cityTz || "тАФ";

      const dtCity = getSelectedDateTime().setZone(tz);
      const dtUtc = dtCity.toUTC();

      const d0 = dtCity.toISODate();
      const dPrev = dtCity.minus({ days:1 }).toISODate();
      const dNext = dtCity.plus({ days:1 }).toISODate();

      // Only one visible timestamp (Selected). Share stamp is share-mode only.
      const stamp = dtCity.toFormat("dd LLL yyyy, hh:mm a");
      selectedStamp.textContent = stamp;
      shareStamp.textContent = `${state.city || DEFAULT_CITY} ┬╖ ${stamp}`;

      // Load sun data (3 days) when we have lat/lon
      if(state.lat != null && state.lon != null){
        try{
          await loadSun3Days(state.lat, state.lon, tz, dPrev, dNext);
        }catch(e){
          showError("Sunrise/Sunset API failure", e.message);
        }
      }

      // Calendar
      const mInfo = tamilMonthFromDate(dtCity);
      const dayNo = tamilDayNumber(dtCity, mInfo);
      const yearName = tamilYearName(dtCity);
      const weekday = WEEKDAY_TA[dtCity.weekday] || "тАФ";
      const pan = panchang(dtUtc);

      outYear.textContent = `${yearName} роЖрогрпНроЯрпБ`;
      outSeason.textContent = mInfo.season;
      outMonth.textContent = mInfo.name;
      outNakshatra.textContent = pan.nName;
      outPaksha.textContent = pan.paksha;
      outTithi.textContent = pan.tName;
      outDayNum.textContent = dayNo;
      outWeekday.textContent = weekday;

      const sun = getSun(d0);
      if(sun){
        outDayNight.textContent = isDay(dtCity, sun) ? "рокроХро▓рпН" : "роЗро░ро╡рпБ";

        const ls = lastSunriseBefore(dtCity);
        if(ls){
          const tt = tamilTime(dtCity, ls);
          outSaamamNo.textContent = tt.saamam;
          outNaz.textContent = tt.nazhigai;
          outMin.textContent = tt.minuteInNazhi;
          outVinadi.textContent = tt.vinadi;
        }else{
          outSaamamNo.textContent = "тАФ";
          outNaz.textContent = "тАФ";
          outMin.textContent = "тАФ";
          outVinadi.textContent = dtCity.second;
        }

        const wd = dtCity.weekday;
        const rahu = segmentWindow(dtCity, sun, RAHU_IDX[wd]);
        const yama = segmentWindow(dtCity, sun, YAMA_IDX[wd]);
        const guli = segmentWindow(dtCity, sun, GULI_IDX[wd]);

        outRahuStart.textContent = rahu ? fmtTime(rahu.start) : "тАФ";
        outRahuEnd.textContent   = rahu ? fmtTime(rahu.end)   : "тАФ";
        outYamaStart.textContent = yama ? fmtTime(yama.start) : "тАФ";
        outYamaEnd.textContent   = yama ? fmtTime(yama.end)   : "тАФ";
        outGulikaStart.textContent = guli ? fmtTime(guli.start) : "тАФ";
        outGulikaEnd.textContent   = guli ? fmtTime(guli.end)   : "тАФ";
      }else{
        outDayNight.textContent = "тАФ";
        outSaamamNo.textContent = "тАФ";
        outNaz.textContent = "тАФ";
        outMin.textContent = "тАФ";
        outVinadi.textContent = dtCity.second;
        outRahuStart.textContent = "тАФ"; outRahuEnd.textContent = "тАФ";
        outYamaStart.textContent = "тАФ"; outYamaEnd.textContent = "тАФ";
        outGulikaStart.textContent = "тАФ"; outGulikaEnd.textContent = "тАФ";
      }

      footNote.textContent = APP_NAME;
      infoBox.textContent = disclaimerText();
    }

    async function setCity(cityName, { resetToNow=false } = {}){
      clearError();
      const q = (cityName || "").trim();
      if(!q) return;

      cityGo.disabled = true;
      cityGo.textContent = "LoadingтАж";

      try{
        const best = await geocodeCity(q);
        state.city = [best.name, best.admin1].filter(Boolean).join(", ");
        state.lat = best.latitude;
        state.lon = best.longitude;
        state.cityTz = best.timezone || null;

        cityTitle.textContent = state.city;
        cityTzEl.textContent = state.cityTz || "тАФ";

        if(resetToNow) setDtInputNow();
        await recalcAndRender();
      }catch(e){
        showError("Geocoding API failure", e.message);
      }finally{
        cityGo.disabled = false;
        cityGo.textContent = "Search";
      }
    }

    async function shareScreenshot(){
      clearError();
      const shareArea = document.getElementById("shareArea");

      document.body.classList.add("sharing");
      await new Promise(r => setTimeout(r, 80));

      try{
        const canvas = await html2canvas(shareArea, {
          backgroundColor: "#070a10",
          scale: Math.min(2, window.devicePixelRatio || 1),
          useCORS: true
        });

        const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png", 0.95));
        if(!blob) throw new Error("Screenshot failed");

        const tz = effectiveTz();
        const dtCity = getSelectedDateTime().setZone(tz);
        const safeName = `${APP_NAME}-${(state.city||DEFAULT_CITY)}-${dtCity.toFormat("yyyyLLdd-HHmm")}`
          .replace(/[^\w\u0B80-\u0BFF\-]+/g, "_");

        const file = new File([blob], `${safeName}.png`, { type: "image/png" });

        if(navigator.canShare && navigator.canShare({ files: [file] })){
          await navigator.share({ title: APP_NAME, text: APP_NAME, files: [file] });
        } else {
          // fallback: download
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = `${safeName}.png`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(a.href);
        }
      }catch(e){
        showError("Share failed", e.message);
      }finally{
        document.body.classList.remove("sharing");
      }
    }

    // UI hooks
    cityGo.addEventListener("click", () => setCity(cityInput.value, { resetToNow:true }));
    cityInput.addEventListener("keydown", (e) => { if(e.key === "Enter") setCity(cityInput.value, { resetToNow:true }); });

    btnNow.addEventListener("click", async () => { setDtInputNow(); await recalcAndRender(); });
    btnRefresh.addEventListener("click", () => recalcAndRender().catch(e => showError("Recalc failed", e.message)));
    btnShare.addEventListener("click", () => shareScreenshot());

    dtInput.addEventListener("change", () => recalcAndRender().catch(e => showError("Recalc failed", e.message)));

    // Init
    (async function init(){
      document.title = APP_NAME;
      cityInput.value = DEFAULT_CITY;
      infoBox.textContent = disclaimerText();

      await setCity(DEFAULT_CITY, { resetToNow:true });

      // If API blocked: still render with device tz
      if(state.lat == null || state.lon == null){
        state.city = DEFAULT_CITY;
        cityTitle.textContent = DEFAULT_CITY;
        state.cityTz = state.deviceTz;
        cityTzEl.textContent = state.cityTz;
        setDtInputNow();
        await recalcAndRender();
      }
    })();
  </script>
</body>
</html>
