<!doctype html>
<html lang="ta">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <meta name="color-scheme" content="dark light" />

  <title>‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç ¬∑ Ramar Kandasamy ¬∑ ram.kabil@gmailcom</title>

  <!-- Deep author watermarking / anti-copy meta -->
  <meta name="application-name" content="‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç">
  <meta name="apple-mobile-web-app-title" content="‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç">
  <meta name="author" content="Ramar Kandasamy">
  <meta name="creator" content="Ramar Kandasamy">
  <meta name="publisher" content="Ramar Kandasamy">
  <meta name="email" content="ram.kabil@gmailcom">
  <meta name="description" content="‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç ‚Äî ‡Æ®‡Ææ‡Æ¥‡Æø‡Æï‡Øà / ‡Æö‡Ææ‡ÆÆ‡ÆÆ‡Øç / ‡Æ™‡Æû‡Øç‡Æö‡Ææ‡Æô‡Øç‡Æï‡ÆÆ‡Øç. Author: Ramar Kandasamy (ram.kabil@gmailcom).">
  <meta name="keywords" content="‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç, Tamil time, naazhigai, saamam, panchangam, Ramar Kandasamy, ram.kabil@gmailcom">
  <meta name="robots" content="index,follow">

  <!-- Fonts: Tiro Tamil for Tamil text, Roboto for numbers -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Tiro+Tamil:ital,wght@0,400;1,400&display=swap" rel="stylesheet">

  <!-- Luxon for correct timezone handling -->
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>

  <!-- html2canvas for Share screenshot -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- JSON-LD (extra deep author embedding) -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"SoftwareApplication",
    "name":"‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç",
    "applicationCategory":"UtilitiesApplication",
    "operatingSystem":"Web",
    "author":{"@type":"Person","name":"Ramar Kandasamy","email":"ram.kabil@gmailcom"},
    "publisher":{"@type":"Person","name":"Ramar Kandasamy","email":"ram.kabil@gmailcom"}
  }
  </script>

  <style>
    :root{
      --bg: #070a10;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.55);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 10% 0%, rgba(120,180,255,.16), transparent 60%),
        radial-gradient(900px 550px at 90% 20%, rgba(255,160,210,.12), transparent 55%),
        radial-gradient(900px 600px at 50% 100%, rgba(180,255,210,.08), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family: "Tiro Tamil", serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      position: relative;
    }

    /* Deep watermark: subtle, always present */
    body::before{
      content:"Ramar Kandasamy ‚Ä¢ ram.kabil@gmailcom ‚Ä¢ ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç";
      position: fixed;
      inset: 0;
      pointer-events:none;
      z-index: 0;
      opacity: .035;
      color: rgba(255,255,255,.85);
      font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
      font-size: 18px;
      letter-spacing: .9px;
      white-space: pre-wrap;
      line-height: 1.8;
      transform: rotate(-12deg);
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 40px;
    }

    .wrap{
      max-width: 760px;
      margin: 0 auto;
      padding: 26px 16px 44px;
      position: relative;
      z-index: 1;
    }

    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:space-between;
      margin-bottom:16px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }

    .logo{
      width:40px; height:40px;
      border-radius:14px;
      background: linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.06));
      border:1px solid var(--stroke);
      box-shadow: 0 10px 28px rgba(0,0,0,.35);
      position:relative;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .logo:before{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 55%);
      transform: rotate(18deg);
    }

    .title{
      display:flex; flex-direction:column; line-height:1.15;
      min-width:0;
    }
    .title .h{
      font-size: 18px;
      font-weight: 400;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .title .sub{
      font-size: 13px;
      color: var(--muted2);
      font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .actions{
      display:flex; align-items:center; gap:10px;
    }

    .iconbtn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      transition: transform .12s ease, background .12s ease;
      user-select:none;
      font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
      white-space:nowrap;
    }
    .iconbtn:active{ transform: scale(.98); }
    .iconbtn:hover{ background: rgba(255,255,255,.085); }

    .maincard{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .cardpad{ padding: 16px; }

    .searchRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      margin-bottom: 12px;
    }

    .input{
      width:100%;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.30);
      color: var(--text);
      padding: 12px 14px;
      outline:none;
      font-size: 16px;
      font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
    }
    .input::placeholder{ color: rgba(255,255,255,.45); }

    .btn{
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.10);
      color: var(--text);
      padding: 12px 14px;
      font-size: 15px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
      font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
      white-space:nowrap;
    }
    .btn:hover{ background: rgba(255,255,255,.14); }
    .btn:active{ transform: scale(.98); }

    .pickerRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 8px;
    }

    .helper{
      font-size: 12px;
      color: var(--muted2);
      margin: 8px 2px 2px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
    }

    .lines{
      padding: 12px 16px 18px;
      border-top: 1px solid rgba(255,255,255,.07);
    }

    .line{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 14px;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .line:last-child{ border-bottom:0; }

    .k{
      color: var(--muted);
      font-size: 16px;
      letter-spacing:.1px;
      flex: 0 0 auto;
    }

    .v{
      text-align:right;
      font-size: 20px;
      font-weight: 400;
      letter-spacing:.2px;
      flex: 1 1 auto;
      min-width: 0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .num{
      font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
      font-variant-numeric: tabular-nums;
    }

    .bigOnly{
      font-size: 24px;
      letter-spacing:.2px;
    }

    .chips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .chip{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
    }

    .info{
      margin-top: 0;
      border-top: 1px solid rgba(255,255,255,.07);
    }

    details{
      padding: 10px 16px 16px;
    }
    summary{
      list-style:none;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
      padding: 10px 0;
      user-select:none;
    }
    summary::-webkit-details-marker{ display:none; }

    .infobox{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.28);
      border-radius: 16px;
      padding: 12px;
      color: rgba(255,255,255,.80);
      font-size: 13px;
      line-height: 1.55;
      font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
      white-space: pre-wrap;
    }

    .footer{
      margin-top: 14px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      flex-wrap:wrap;
      align-items:center;
      color: var(--muted2);
      font-size: 12px;
      font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
    }

    .donate{
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      color: var(--text);
      transition: transform .12s ease, background .12s ease;
    }
    .donate:hover{ background: rgba(255,255,255,.12); }
    .donate:active{ transform: scale(.98); }

    .err{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,120,120,.22);
      background: rgba(255,80,80,.08);
      color: rgba(255,210,210,.92);
      font-size: 13px;
      font-family: "Roboto", system-ui, -apple-system, Segoe UI, sans-serif;
      display:none;
      white-space: pre-wrap;
    }

    /* Share mode: hide these */
    .no-share{ display: inline-flex; }
    body.sharing .no-share{ display:none !important; }
    body.sharing details{ display:none !important; }
    body.sharing .footer{ display:none !important; }
    body.sharing body::before{ opacity: .05; } /* watermark still exists */

    /* Ensure screenshot area looks clean */
    #shareArea{
      border-radius: 22px;
    }

    @media (max-width:520px){
      .pickerRow{ grid-template-columns: 1fr; }
      .v{ font-size: 19px; }
      .bigOnly{ font-size: 22px; }
    }
  </style>
</head>

<body data-author="Ramar Kandasamy" data-email="ram.kabil@gmailcom" data-app="‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç">
  <!-- Hidden deep signature -->
  <div style="display:none">
    ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç ‚Äî Author: Ramar Kandasamy ‚Äî Email: ram.kabil@gmailcom ‚Äî ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç ‚Äî Ramar Kandasamy ‚Äî ram.kabil@gmailcom
  </div>

  <div class="wrap">
    <!-- Share will capture ONLY this area -->
    <div id="shareArea" data-owner="Ramar Kandasamy" data-contact="ram.kabil@gmailcom" data-appname="‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="title">
            <div class="h" id="cityTitle">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç</div>
            <div class="sub" id="metaTitle">
              Device TZ: <span id="deviceTz">‚Äî</span> ¬∑ City TZ: <span id="cityTz">‚Äî</span> ¬∑ Ramar Kandasamy ¬∑ ram.kabil@gmailcom
            </div>
          </div>
        </div>

        <div class="actions no-share">
          <button class="iconbtn" id="btnShare" title="Share">
            <span aria-hidden="true">üì§</span><span class="num">Share</span>
          </button>
          <button class="iconbtn" id="btnNow" title="Now">
            <span aria-hidden="true">‚è±Ô∏è</span><span class="num">Now</span>
          </button>
          <button class="iconbtn" id="btnRefresh" title="Refresh">
            <span aria-hidden="true">‚Üª</span><span class="num">Refresh</span>
          </button>
        </div>
      </div>

      <div class="maincard">
        <div class="cardpad">
          <div class="searchRow no-share">
            <input id="cityInput" class="input" placeholder="City (e.g., Madurai, Chennai, Singapore)" value="Madurai" />
            <button id="cityGo" class="btn">Search</button>
          </div>

          <div class="pickerRow no-share">
            <input id="dtInput" class="input" type="datetime-local" />
            <select id="modeInput" class="input" style="cursor:pointer">
              <option value="device">Device Timezone (default)</option>
              <option value="city">City Timezone</option>
            </select>
          </div>

          <div class="helper">
            <div>Selected converts using: <span class="num" id="usingTz">‚Äî</span></div>
            <div>Sunrise/Sunset for: <span class="num" id="sunForDate">‚Äî</span></div>
          </div>

          <div class="err" id="errBox"></div>

          <div class="lines" id="lines">
            <!-- BIG CHANGE: Year value becomes "year_name ‡ÆÜ‡Æ£‡Øç‡Æü‡ØÅ" (single value), not "‡ÆÜ‡Æ£‡Øç‡Æü‡ØÅ: year_name" -->
            <div class="line">
              <div class="k">‡ÆÜ‡Æ£‡Øç‡Æü‡ØÅ</div>
              <div class="v" id="outYear">‚Äî</div>
            </div>

            <div class="line">
              <div class="k">‡Æ™‡Æ∞‡ØÅ‡Æµ‡ÆÆ‡Øç</div>
              <div class="v" id="outSeason">‚Äî</div>
            </div>

            <div class="line">
              <div class="k">‡ÆÆ‡Ææ‡Æ§‡ÆÆ‡Øç</div>
              <div class="v" id="outMonth">‚Äî</div>
            </div>

            <div class="line">
              <div class="k">‡Æ®‡Æü‡Øç‡Æö‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡ÆÆ‡Øç</div>
              <div class="v" id="outNakshatra">‚Äî</div>
            </div>

            <div class="line">
              <div class="k">‡Æ§‡Æø‡Æ§‡Æø</div>
              <div class="v" id="outTithi">‚Äî</div>
            </div>

            <div class="line">
              <div class="k">‡Æ§‡Øá‡Æ§‡Æø</div>
              <div class="v"><span class="num" id="outDayNum">‚Äî</span></div>
            </div>

            <div class="line">
              <div class="k">‡Æï‡Æø‡Æ¥‡ÆÆ‡Øà</div>
              <div class="v" id="outWeekday">‚Äî</div>
            </div>

            <div class="line">
              <div class="k">‡Æ™‡Æï‡Æ≤‡Øç / ‡Æá‡Æ∞‡Æµ‡ØÅ</div>
              <div class="v bigOnly" id="outDayNight">‚Äî</div>
            </div>

            <div class="line">
              <div class="k">‡Æö‡Ææ‡ÆÆ‡ÆÆ‡Øç</div>
              <div class="v">
                <span class="num" id="outSaamamNo">‚Äî</span> / <span class="num">8</span>
              </div>
            </div>

            <div class="line">
              <div class="k">‡Æ®‡Ææ‡Æ¥‡Æø‡Æï‡Øà</div>
              <div class="v"><span class="num" id="outNaz">‚Äî</span> / <span class="num">60</span></div>
            </div>

            <div class="line">
              <div class="k">‡Æ®‡Æø‡ÆÆ‡Æø‡Æü‡ÆÆ‡Øç</div>
              <div class="v"><span class="num" id="outMin">‚Äî</span></div>
            </div>

            <div class="line">
              <div class="k">‡Æµ‡Æø‡Æ©‡Ææ‡Æü‡Æø</div>
              <div class="v"><span class="num" id="outVinadi">‚Äî</span></div>
            </div>

            <div class="chips">
              <div class="chip">Day-cycle: <span class="num" id="outNazCycle">‚Äî</span> / 60 ‡Æ®‡Ææ‡Æ¥‡Æø‡Æï‡Øà</div>
              <div class="chip">Day-cycle: <span class="num" id="outSaamamCycle">‚Äî</span> / 8 ‡Æö‡Ææ‡ÆÆ‡ÆÆ‡Øç</div>
              <div class="chip">¬© <span class="num">Ramar Kandasamy</span> ¬∑ <span class="num">ram.kabil@gmailcom</span></div>
            </div>
          </div>
        </div>

        <div class="info">
          <details id="infoDetails" class="no-share">
            <summary>
              <span>Info ¬∑ Disclaimer ¬∑ Dependencies</span>
              <span aria-hidden="true">‚ñæ</span>
            </summary>
            <div class="infobox" id="infoBox">‚Äî</div>
          </details>
        </div>
      </div>
    </div>

    <div class="footer no-share">
      <div>
        <a class="donate" id="donateBtn" href="upi://pay?pa=8903448384@upi&pn=Ramar%20Kandasamy&cu=INR">
          <span aria-hidden="true">‚ù§Ô∏è</span> Donate <span class="num">UPI</span>
        </a>
      </div>
      <div class="num" id="footNote">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç ¬∑ Ramar Kandasamy ¬∑ ram.kabil@gmailcom</div>
    </div>
  </div>

  <script>
    // ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç ‚Äî Author watermark: Ramar Kandasamy ‚Äî ram.kabil@gmailcom
    const { DateTime } = luxon;

    // ---------- Config ----------
    const APP_NAME = "‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç";
    const AUTHOR_NAME = "Ramar Kandasamy";
    const AUTHOR_EMAIL = "ram.kabil@gmailcom";

    const DEFAULT_CITY = "Madurai";

    // Approx Tamil solar month boundaries (simple table, not exact sankranti timings)
    const TAMIL_MONTHS = [
      { name: "‡Æö‡Æø‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Øà",   start: { m: 4,  d: 14 }, season: "‡Æá‡Æ≥‡Æµ‡Øá‡Æ©‡Æø‡Æ≤‡Øç" },
      { name: "‡Æµ‡Øà‡Æï‡Ææ‡Æö‡Æø",    start: { m: 5,  d: 15 }, season: "‡Æá‡Æ≥‡Æµ‡Øá‡Æ©‡Æø‡Æ≤‡Øç" },
      { name: "‡ÆÜ‡Æ©‡Æø",       start: { m: 6,  d: 15 }, season: "‡ÆÆ‡ØÅ‡Æ§‡ØÅ‡Æµ‡Øá‡Æ©‡Æø‡Æ≤‡Øç" },
      { name: "‡ÆÜ‡Æü‡Æø",       start: { m: 7,  d: 16 }, season: "‡ÆÆ‡ØÅ‡Æ§‡ØÅ‡Æµ‡Øá‡Æ©‡Æø‡Æ≤‡Øç" },
      { name: "‡ÆÜ‡Æµ‡Æ£‡Æø",     start: { m: 8,  d: 16 }, season: "‡Æï‡Ææ‡Æ∞‡Øç" },
      { name: "‡Æ™‡ØÅ‡Æ∞‡Æü‡Øç‡Æü‡Ææ‡Æö‡Æø", start: { m: 9,  d: 16 }, season: "‡Æï‡Ææ‡Æ∞‡Øç" },
      { name: "‡Æê‡Æ™‡Øç‡Æ™‡Æö‡Æø",    start: { m: 10, d: 17 }, season: "‡Æï‡ØÇ‡Æ§‡Æø‡Æ∞‡Øç" },
      { name: "‡Æï‡Ææ‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡Æø‡Æï‡Øà",start: { m: 11, d: 16 }, season: "‡Æï‡ØÇ‡Æ§‡Æø‡Æ∞‡Øç" },
      { name: "‡ÆÆ‡Ææ‡Æ∞‡Øç‡Æï‡Æ¥‡Æø",   start: { m: 12, d: 16 }, season: "‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ™‡Æ©‡Æø" },
      { name: "‡Æ§‡Øà",        start: { m: 1,  d: 14 }, season: "‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ™‡Æ©‡Æø" },
      { name: "‡ÆÆ‡Ææ‡Æö‡Æø",      start: { m: 2,  d: 13 }, season: "‡Æ™‡Æø‡Æ©‡Øç‡Æ™‡Æ©‡Æø" },
      { name: "‡Æ™‡Æô‡Øç‡Æï‡ØÅ‡Æ©‡Æø",   start: { m: 3,  d: 14 }, season: "‡Æ™‡Æø‡Æ©‡Øç‡Æ™‡Æ©‡Æø" }
    ];

    // 60-year cycle (simple anchor for Apr 14, 1987 = Prabhava)
    const TAMIL_YEAR_NAMES = [
      "‡Æ™‡Æø‡Æ∞‡Æ™‡Æµ", "‡Æµ‡Æø‡Æ™‡Æµ", "‡Æö‡ØÅ‡Æï‡Øç‡Æ≤", "‡Æ™‡Æø‡Æ∞‡ÆÆ‡Øã‡Æ§‡ØÇ‡Æ§", "‡Æ™‡Æø‡Æ∞‡Æú‡Øã‡Æ±‡Øç‡Æ™‡Æ§‡Øç‡Æ§‡Æø", "‡ÆÜ‡Æô‡Øç‡Æï‡ØÄ‡Æ∞‡Æö",
      "‡Æ∏‡Øç‡Æ∞‡ØÄ‡ÆÆ‡ØÅ‡Æï", "‡Æ™‡Ææ‡Æµ", "‡ÆØ‡ØÅ‡Æµ", "‡Æ§‡Ææ‡Æ§‡ØÅ", "‡Æà‡Æ∏‡Øç‡Æµ‡Æ∞", "‡Æµ‡ØÜ‡Æï‡ØÅ‡Æ§‡Ææ‡Æ©‡Øç‡ÆØ",
      "‡Æ™‡Æø‡Æ∞‡ÆÆ‡Ææ‡Æ§‡Æø", "‡Æµ‡Æø‡Æï‡Øç‡Æ∞‡ÆÆ", "‡Æµ‡Æø‡Æ∑‡ØÅ", "‡Æö‡Æø‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Æ™‡Ææ‡Æ©‡ØÅ", "‡Æö‡ØÅ‡Æ™‡Ææ‡Æ©‡ØÅ", "‡Æ§‡Ææ‡Æ∞‡Æ£",
      "‡Æ™‡Ææ‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡Æø‡Æ™", "‡Æµ‡Æø‡ÆØ", "‡Æö‡Æ∞‡Øç‡Æµ‡Æú‡Æø‡Æ§‡Øç", "‡Æö‡Æ∞‡Øç‡Æµ‡Æ§‡Ææ‡Æ∞‡Æø", "‡Æµ‡Æø‡Æ∞‡Øã‡Æ§‡Æø", "‡Æµ‡Æø‡Æï‡Øç‡Æ∞‡ØÅ‡Æ§‡Æø",
      "‡Æï‡Æ∞", "‡Æ®‡Æ®‡Øç‡Æ§‡Æ©", "‡Æµ‡Æø‡Æú‡ÆØ", "‡Æú‡ÆØ", "‡ÆÆ‡Æ©‡Øç‡ÆÆ‡Æ§", "‡Æ§‡ØÅ‡Æ∞‡Øç‡ÆÆ‡ØÅ‡Æï‡Æø",
      "‡Æπ‡Øá‡Æµ‡Æø‡Æ≥‡ÆÆ‡Øç‡Æ™‡Æø", "‡Æµ‡Æø‡Æ≥‡ÆÆ‡Øç‡Æ™‡Æø", "‡Æµ‡Æø‡Æï‡Ææ‡Æ∞‡Æø", "‡Æö‡Ææ‡Æ∞‡Øç‡Æµ‡Æ∞‡Æø", "‡Æ™‡Æø‡Æ≤‡Æµ", "‡Æö‡ØÅ‡Æ™‡Æï‡Æø‡Æ∞‡ØÅ‡Æ§‡ØÅ",
      "‡Æö‡Øã‡Æ™‡Æï‡Æø‡Æ∞‡ØÅ‡Æ§‡ØÅ", "‡Æï‡ØÅ‡Æ∞‡Øã‡Æ§‡Æø", "‡Æµ‡Æø‡Æö‡ØÅ‡Æµ‡Ææ‡Æö‡ØÅ", "‡Æ™‡Æ∞‡Ææ‡Æ™‡Æµ", "‡Æ™‡Æø‡Æ≤‡Æµ‡Æô‡Øç‡Æï",
      "‡Æï‡ØÄ‡Æ≤‡Æï", "‡Æö‡Øå‡ÆÆ‡Øç‡ÆØ", "‡Æö‡Ææ‡Æ§‡Ææ‡Æ∞‡Æ£", "‡Æµ‡Æø‡Æ∞‡Øã‡Æ§‡Æø‡Æï‡Æø‡Æ∞‡ØÅ‡Æ§‡ØÅ", "‡Æ™‡Æ∞‡Æø‡Æ§‡Ææ‡Æ™‡Æø",
      "‡Æ™‡Æø‡Æ∞‡ÆÆ‡Ææ‡Æ§‡ØÄ‡Æö", "‡ÆÜ‡Æ©‡Æ®‡Øç‡Æ§", "‡Æ∞‡Ææ‡Æï‡Øç‡Æ∑‡Æö", "‡Æ®‡Æ≥", "‡Æ™‡Æø‡Æô‡Øç‡Æï‡Æ≥", "‡Æï‡Ææ‡Æ≥‡ÆØ‡ØÅ‡Æï‡Øç‡Æ§‡Æø",
      "‡Æö‡Æø‡Æ§‡Øç‡Æ§‡Ææ‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡Æø", "‡Æ∞‡Øå‡Æ§‡Øç‡Æ∞‡Æø", "‡Æ§‡ØÅ‡Æ©‡Øç‡ÆÆ‡Æ§‡Æø", "‡Æ§‡ØÅ‡Æ®‡Øç‡Æ§‡ØÅ‡Æ™‡Æø", "‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ∞‡Øã‡Æ§‡Øç‡Æï‡Ææ‡Æ∞‡Æø",
      "‡Æ∞‡Æï‡Øç‡Æ§‡Ææ‡Æü‡Øç‡Æö‡Æø", "‡Æï‡Øç‡Æ∞‡Øã‡Æ§‡Æ©", "‡ÆÖ‡Æï‡Øç‡Æ∑‡ÆØ"
    ];

    // Luxon weekday: Mon=1..Sun=7
    const WEEKDAY_TA = {
      1:"‡Æ§‡Æø‡Æô‡Øç‡Æï‡Æ≥‡Øç", 2:"‡Æö‡ØÜ‡Æµ‡Øç‡Æµ‡Ææ‡ÆØ‡Øç", 3:"‡Æ™‡ØÅ‡Æ§‡Æ©‡Øç", 4:"‡Æµ‡Æø‡ÆØ‡Ææ‡Æ¥‡Æ©‡Øç", 5:"‡Æµ‡ØÜ‡Æ≥‡Øç‡Æ≥‡Æø", 6:"‡Æö‡Æ©‡Æø", 7:"‡Æû‡Ææ‡ÆØ‡Æø‡Æ±‡ØÅ"
    };

    // Tithi names (1..30)
    const TITHI_NAMES = [
      "‡Æ™‡Æø‡Æ∞‡Æ§‡ÆÆ‡Øà","‡Æ§‡Øç‡Æµ‡Æø‡Æ§‡Æø‡ÆØ‡Øà","‡Æ§‡Æø‡Æ∞‡Æø‡Æ§‡Æø‡ÆØ‡Øà","‡Æö‡Æ§‡ØÅ‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡Æø","‡Æ™‡Æû‡Øç‡Æö‡ÆÆ‡Æø","‡Æ∑‡Æ∑‡Øç‡Æü‡Æø","‡Æö‡Æ™‡Øç‡Æ§‡ÆÆ‡Æø","‡ÆÖ‡Æ∑‡Øç‡Æü‡ÆÆ‡Æø","‡Æ®‡Æµ‡ÆÆ‡Æø","‡Æ§‡Æö‡ÆÆ‡Æø","‡Æè‡Æï‡Ææ‡Æ§‡Æö‡Æø","‡Æ§‡Øç‡Æµ‡Ææ‡Æ§‡Æö‡Æø","‡Æ§‡Æø‡Æ∞‡ÆØ‡Øã‡Æ§‡Æö‡Æø","‡Æö‡Æ§‡ØÅ‡Æ∞‡Øç‡Æ§‡Æö‡Æø","‡Æ™‡Øå‡Æ∞‡Øç‡Æ£‡ÆÆ‡Æø",
      "‡Æ™‡Æø‡Æ∞‡Æ§‡ÆÆ‡Øà","‡Æ§‡Øç‡Æµ‡Æø‡Æ§‡Æø‡ÆØ‡Øà","‡Æ§‡Æø‡Æ∞‡Æø‡Æ§‡Æø‡ÆØ‡Øà","‡Æö‡Æ§‡ØÅ‡Æ∞‡Øç‡Æ§‡Øç‡Æ§‡Æø","‡Æ™‡Æû‡Øç‡Æö‡ÆÆ‡Æø","‡Æ∑‡Æ∑‡Øç‡Æü‡Æø","‡Æö‡Æ™‡Øç‡Æ§‡ÆÆ‡Æø","‡ÆÖ‡Æ∑‡Øç‡Æü‡ÆÆ‡Æø","‡Æ®‡Æµ‡ÆÆ‡Æø","‡Æ§‡Æö‡ÆÆ‡Æø","‡Æè‡Æï‡Ææ‡Æ§‡Æö‡Æø","‡Æ§‡Øç‡Æµ‡Ææ‡Æ§‡Æö‡Æø","‡Æ§‡Æø‡Æ∞‡ÆØ‡Øã‡Æ§‡Æö‡Æø","‡Æö‡Æ§‡ØÅ‡Æ∞‡Øç‡Æ§‡Æö‡Æø","‡ÆÖ‡ÆÆ‡Ææ‡Æµ‡Ææ‡Æö‡Øà"
    ];

    // Nakshatra names (1..27)
    const NAKSHATRA_NAMES = [
      "‡ÆÖ‡Æ∏‡Øç‡Æµ‡Æø‡Æ©‡Æø","‡Æ™‡Æ∞‡Æ£‡Æø","‡Æï‡Æø‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡Æø‡Æï‡Øà","‡Æ∞‡Øã‡Æπ‡Æø‡Æ£‡Æø","‡ÆÆ‡Æø‡Æ∞‡ØÅ‡Æï‡Æö‡ØÄ‡Æ∞‡Æø‡Æü‡ÆÆ‡Øç","‡Æ§‡Æø‡Æ∞‡ØÅ‡Æµ‡Ææ‡Æ§‡Æø‡Æ∞‡Øà","‡Æ™‡ØÅ‡Æ©‡Æ∞‡Øç‡Æ™‡ØÇ‡Æö‡ÆÆ‡Øç","‡Æ™‡ØÇ‡Æö‡ÆÆ‡Øç","‡ÆÜ‡ÆØ‡Æø‡Æ≤‡Øç‡ÆØ‡ÆÆ‡Øç",
      "‡ÆÆ‡Æï‡ÆÆ‡Øç","‡Æ™‡ØÇ‡Æ∞‡ÆÆ‡Øç","‡Æâ‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡ÆÆ‡Øç","‡Æπ‡Æ∏‡Øç‡Æ§‡ÆÆ‡Øç","‡Æö‡Æø‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Øà","‡Æö‡ØÅ‡Æµ‡Ææ‡Æ§‡Æø","‡Æµ‡Æø‡Æö‡Ææ‡Æï‡ÆÆ‡Øç","‡ÆÖ‡Æ©‡ØÅ‡Æ∑‡ÆÆ‡Øç","‡Æï‡Øá‡Æü‡Øç‡Æü‡Øà",
      "‡ÆÆ‡ØÇ‡Æ≤‡ÆÆ‡Øç","‡Æ™‡ØÇ‡Æ∞‡Ææ‡Æü‡ÆÆ‡Øç","‡Æâ‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Ææ‡Æü‡ÆÆ‡Øç","‡Æ§‡Æø‡Æ∞‡ØÅ‡Æµ‡Øã‡Æ£‡ÆÆ‡Øç","‡ÆÖ‡Æµ‡Æø‡Æü‡Øç‡Æü‡ÆÆ‡Øç","‡Æö‡Æ§‡ÆØ‡ÆÆ‡Øç","‡Æ™‡ØÇ‡Æ∞‡Æü‡Øç‡Æü‡Ææ‡Æ§‡Æø","‡Æâ‡Æ§‡Øç‡Æ§‡Æø‡Æ∞‡Æü‡Øç‡Æü‡Ææ‡Æ§‡Æø","‡Æ∞‡Øá‡Æµ‡Æ§‡Æø"
    ];

    // Yoga names (1..27)
    const YOGA_NAMES = [
      "‡Æµ‡Æø‡Æ∑‡Øç‡Æï‡ÆÆ‡Øç‡Æ™‡ÆÆ‡Øç","‡Æ™‡Æø‡Æ∞‡ØÄ‡Æ§‡Æø","‡ÆÜ‡ÆØ‡ØÅ‡Æ∑‡Øç‡ÆÆ‡Ææ‡Æ©‡Øç","‡Æö‡Øå‡Æ™‡Ææ‡Æï‡Øç‡ÆØ‡ÆÆ‡Øç","‡Æö‡Øã‡Æ™‡Æ©‡ÆÆ‡Øç","‡ÆÖ‡Æ§‡Æø‡Æï‡Æ£‡Øç‡Æü‡ÆÆ‡Øç","‡Æö‡ØÅ‡Æï‡Æ∞‡Øç‡ÆÆ‡Ææ","‡Æ§‡Øç‡Æ∞‡ØÅ‡Æ§‡Æø","‡Æö‡ØÇ‡Æ≤‡ÆÆ‡Øç",
      "‡Æï‡Æ£‡Øç‡Æü‡ÆÆ‡Øç","‡Æµ‡Æø‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡Æø","‡Æ§‡ØÅ‡Æ∞‡ØÅ‡Æµ‡ÆÆ‡Øç","‡Æµ‡Øç‡ÆØ‡Ææ‡Æï‡Ææ‡Æ§‡ÆÆ‡Øç","‡Æπ‡Æ∞‡Øç‡Æ∑‡Æ£‡ÆÆ‡Øç","‡Æµ‡Æú‡Øç‡Æ∞‡ÆÆ‡Øç","‡Æö‡Æø‡Æ§‡Øç‡Æ§‡Æø","‡Æµ‡Øç‡ÆØ‡Æ§‡ØÄ‡Æ™‡Ææ‡Æ§‡ÆÆ‡Øç","‡Æµ‡Æ∞‡Æø‡ÆØ‡Ææ‡Æ©‡Øç",
      "‡Æ™‡Æ∞‡Æø‡Æï‡ÆÆ‡Øç","‡Æö‡Æø‡Æµ‡ÆÆ‡Øç","‡Æö‡Æø‡Æ§‡Øç‡Æ§‡ÆÆ‡Øç","‡Æö‡Ææ‡Æ§‡Øç‡ÆØ‡ÆÆ‡Øç","‡Æö‡ØÅ‡Æ™‡ÆÆ‡Øç","‡Æö‡ØÅ‡Æï‡Øç‡Æ≤‡ÆÆ‡Øç","‡Æ™‡Æø‡Æ∞‡ÆÆ‡Øç‡ÆÆ‡ÆÆ‡Øç","‡Æá‡Æ®‡Øç‡Æ§‡Æø‡Æ∞‡ÆÆ‡Øç","‡Æµ‡Øà‡Æ§‡Øç‡Æ∞‡ØÅ‡Æ§‡Æø"
    ];

    // ---------- DOM ----------
    const el = (id) => document.getElementById(id);

    const cityTitle = el("cityTitle");
    const deviceTzEl = el("deviceTz");
    const cityTzEl = el("cityTz");
    const usingTzEl = el("usingTz");
    const sunForDateEl = el("sunForDate");

    const cityInput = el("cityInput");
    const cityGo = el("cityGo");
    const dtInput = el("dtInput");
    const modeInput = el("modeInput");

    const errBox = el("errBox");

    const outYear = el("outYear");
    const outSeason = el("outSeason");
    const outMonth = el("outMonth");
    const outNakshatra = el("outNakshatra");
    const outTithi = el("outTithi");
    const outDayNum = el("outDayNum");
    const outWeekday = el("outWeekday");
    const outDayNight = el("outDayNight");
    const outSaamamNo = el("outSaamamNo");
    const outNaz = el("outNaz");
    const outMin = el("outMin");
    const outVinadi = el("outVinadi");
    const outNazCycle = el("outNazCycle");
    const outSaamamCycle = el("outSaamamCycle");
    const infoBox = el("infoBox");
    const footNote = el("footNote");

    const btnNow = el("btnNow");
    const btnRefresh = el("btnRefresh");
    const btnShare = el("btnShare");

    // ---------- State ----------
    const state = {
      deviceTz: Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC",
      city: DEFAULT_CITY,
      country: "",
      cityTz: null,
      lat: null,
      lon: null,
      // sunrise/sunset cache by ISO date string => {sunrise, sunset} in city timezone
      sunMap: new Map(),
      lastApiStatus: {
        geocoding: "‚Äî",
        sunrise: "‚Äî"
      }
    };

    // ---------- Error handling ----------
    function showError(title, details, hints){
      const lines = [];
      lines.push(`Error: ${title}`);
      if(details) lines.push(`Details: ${details}`);
      if(hints) lines.push(`Hint: ${hints}`);
      lines.push(`Services: Geocoding=${state.lastApiStatus.geocoding} ¬∑ Sunrise/Sunset=${state.lastApiStatus.sunrise}`);
      lines.push(`Author: ${AUTHOR_NAME} ¬∑ ${AUTHOR_EMAIL}`);
      errBox.style.display = "block";
      errBox.textContent = lines.join("\n");
    }
    function clearError(){
      errBox.style.display = "none";
      errBox.textContent = "";
    }

    // ---------- Helpers ----------
    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function setDtInputNowInDeviceTz(){
      const now = DateTime.now().setZone(state.deviceTz);
      // datetime-local expects "YYYY-MM-DDTHH:mm"
      dtInput.value = `${now.toFormat("yyyy-LL-dd")}T${now.toFormat("HH:mm")}`;
    }

    function getSelectedDateTime(){
      // dtInput is interpreted in chosen timezone (wall-clock)
      const mode = modeInput.value;
      const tz = (mode === "city" && state.cityTz) ? state.cityTz : state.deviceTz;

      if(!dtInput.value){
        return DateTime.now().setZone(tz);
      }
      return DateTime.fromISO(dtInput.value, { zone: tz });
    }

    function tamilMonthFromDate(localDate){
      const y = localDate.year;
      const zone = localDate.zoneName;

      const candidates = TAMIL_MONTHS.map(m => {
        const s = DateTime.fromObject({ year: y, month: m.start.m, day: m.start.d }, { zone }).startOf("day");
        return { ...m, startDT: s };
      });

      let best = null;
      for(const c of candidates){
        if(c.startDT <= localDate && (!best || c.startDT > best.startDT)) best = c;
      }
      if(best) return best;

      // before Chithirai start => Panguni from previous year
      const prevYear = y - 1;
      const panguni = TAMIL_MONTHS.find(m => m.name === "‡Æ™‡Æô‡Øç‡Æï‡ØÅ‡Æ©‡Æø");
      const startPrev = DateTime.fromObject({ year: prevYear, month: panguni.start.m, day: panguni.start.d }, { zone }).startOf("day");
      return { ...panguni, startDT: startPrev };
    }

    function tamilDayNumber(localDate, monthInfo){
      const diffDays = Math.floor(localDate.startOf("day").diff(monthInfo.startDT.startOf("day"), "days").days);
      return diffDays + 1;
    }

    function tamilYearName(localDate){
      // simple boundary: Apr 14
      const zone = localDate.zoneName;
      const y = localDate.year;
      const boundaryThis = DateTime.fromObject({ year: y, month: 4, day: 14 }, { zone }).startOf("day");
      const tamilYearStart = (localDate >= boundaryThis)
        ? boundaryThis
        : DateTime.fromObject({ year: y-1, month: 4, day: 14 }, { zone }).startOf("day");

      const base = DateTime.fromObject({ year: 1987, month: 4, day: 14 }, { zone: "Asia/Kolkata" }).startOf("day");
      const yearsSince = Math.floor(tamilYearStart.toUTC().diff(base.toUTC(), "years").years + 1e-9);
      const idx = ((yearsSince % 60) + 60) % 60;
      return { name: TAMIL_YEAR_NAMES[idx], start: tamilYearStart, idx };
    }

    // ---------- Astronomy (approx) ----------
    function julianDay(dtUtc){
      const y = dtUtc.year;
      const m = dtUtc.month;
      const D = dtUtc.day + (dtUtc.hour + (dtUtc.minute + dtUtc.second/60)/60)/24;
      let Y = y, M = m;
      if(M <= 2){ Y -= 1; M += 12; }
      const A = Math.floor(Y/100);
      const B = 2 - A + Math.floor(A/4);
      return Math.floor(365.25*(Y + 4716)) + Math.floor(30.6001*(M + 1)) + D + B - 1524.5;
    }
    function fixAngle(deg){
      deg = deg % 360;
      if(deg < 0) deg += 360;
      return deg;
    }
    function sunEclLon(jd){
      const T = (jd - 2451545.0) / 36525.0;
      const L0 = fixAngle(280.46646 + 36000.76983*T + 0.0003032*T*T);
      const M  = fixAngle(357.52911 + 35999.05029*T - 0.0001537*T*T);
      const Mr = M * Math.PI/180;
      const C = (1.914602 - 0.004817*T - 0.000014*T*T)*Math.sin(Mr)
              + (0.019993 - 0.000101*T)*Math.sin(2*Mr)
              + 0.000289*Math.sin(3*Mr);
      return fixAngle(L0 + C);
    }
    function moonEclLon(jd){
      const T = (jd - 2451545.0) / 36525.0;
      const L0 = fixAngle(218.3164477 + 481267.88123421*T - 0.0015786*T*T + T*T*T/538841 - T*T*T*T/65194000);
      const D  = fixAngle(297.8501921 + 445267.1114034*T - 0.0018819*T*T + T*T*T/545868 - T*T*T*T/113065000);
      const M  = fixAngle(357.5291092 + 35999.0502909*T - 0.0001536*T*T + T*T*T/24490000);
      const Mp = fixAngle(134.9633964 + 477198.8675055*T + 0.0087414*T*T + T*T*T/69699 - T*T*T*T/14712000);
      const F  = fixAngle(93.2720950  + 483202.0175233*T - 0.0036539*T*T - T*T*T/3526000 + T*T*T*T/863310000);

      const Dr  = D  * Math.PI/180;
      const Mr  = M  * Math.PI/180;
      const Mpr = Mp * Math.PI/180;
      const Fr  = F  * Math.PI/180;

      let lon = L0
        + 6.289 * Math.sin(Mpr)
        + 1.274 * Math.sin(2*Dr - Mpr)
        + 0.658 * Math.sin(2*Dr)
        + 0.214 * Math.sin(2*Mpr)
        - 0.186 * Math.sin(Mr)
        - 0.114 * Math.sin(2*Fr)
        + 0.059 * Math.sin(2*Dr - 2*Mpr)
        + 0.057 * Math.sin(2*Dr - Mr - Mpr)
        + 0.053 * Math.sin(2*Dr + Mpr)
        + 0.046 * Math.sin(2*Dr - Mr)
        + 0.041 * Math.sin(Mr + Mpr)
        - 0.035 * Math.sin(Dr)
        - 0.031 * Math.sin(Mr - Mpr)
        - 0.015 * Math.sin(2*Dr - 2*Fr);

      return fixAngle(lon);
    }

    function tithiFromLongitudes(moonLon, sunLon){
      let diff = fixAngle(moonLon - sunLon);
      const t = Math.floor(diff / 12) + 1; // 1..30
      return { tithi: t, name: TITHI_NAMES[t-1] || "‚Äî", diffDeg: diff };
    }
    function nakshatraFromMoonLon(moonLon){
      const n = Math.floor(fixAngle(moonLon) / (360/27)) + 1;
      return { nak: n, name: NAKSHATRA_NAMES[n-1] || "‚Äî" };
    }
    function yogaFromLongitudes(moonLon, sunLon){
      const sum = fixAngle(moonLon + sunLon);
      const y = Math.floor(sum / (360/27)) + 1;
      return { yoga: y, name: YOGA_NAMES[y-1] || "‚Äî" };
    }
    function karanaFromDiff(diffDeg){
      const halfIndex = Math.floor(diffDeg / 6) + 1; // 1..60
      if(halfIndex === 1) return { half: halfIndex, name: "‡Æï‡Æø‡ÆÆ‡Øç‡Æ∏‡Øç‡Æ§‡ØÅ‡Æï‡Øç‡Æ©" };
      if(halfIndex === 58) return { half: halfIndex, name: "‡Æö‡Æï‡ØÅ‡Æ©‡Æø" };
      if(halfIndex === 59) return { half: halfIndex, name: "‡Æö‡Æ§‡ØÅ‡Æ∑‡Øç‡Æ™‡Ææ‡Æ§‡Øç" };
      if(halfIndex === 60) return { half: halfIndex, name: "‡Æ®‡Ææ‡Æï‡Æµ" };
      const cycle = ["‡Æ™‡Æµ","‡Æ™‡Ææ‡Æ≤‡Æµ","‡Æï‡Øå‡Æ≤‡Æµ","‡Æ§‡Øà‡Æ§‡Æø‡Æ≤","‡Æï‡Æ∞‡Æú","‡Æµ‡Æ£‡Æø‡Æú","‡Æµ‡Æø‡Æ∑‡Øç‡Æü‡Æø"];
      return { half: halfIndex, name: cycle[(halfIndex - 2) % 7] };
    }

    // ---------- Services ----------
    // Open-Meteo Geocoding (worldwide) returns lat/lon + timezone
    async function geocodeCity(name){
      const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(name)}&count=5&language=en&format=json`;
      const r = await fetch(url);
      if(!r.ok) throw new Error(`Geocoding HTTP ${r.status}`);
      const j = await r.json();
      if(!j.results || !j.results.length) throw new Error("City not found");
      const best = j.results[0];
      return {
        name: best.name,
        country: best.country,
        admin1: best.admin1,
        lat: best.latitude,
        lon: best.longitude,
        tz: best.timezone
      };
    }

    // Open-Meteo Forecast daily sunrise/sunset
    async function loadSunriseSunsetRange(lat, lon, tz, startISO, endISO){
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}&daily=sunrise,sunset&timezone=${encodeURIComponent(tz)}&start_date=${startISO}&end_date=${endISO}`;
      const r = await fetch(url);
      if(!r.ok) throw new Error(`Sunrise/Sunset HTTP ${r.status}`);
      const j = await r.json();
      if(!j.daily || !j.daily.time) throw new Error("Sunrise/Sunset data missing");
      for(let i=0;i<j.daily.time.length;i++){
        const d = j.daily.time[i];
        const sunrise = j.daily.sunrise?.[i] || null;
        const sunset  = j.daily.sunset?.[i]  || null;
        if(sunrise && sunset){
          state.sunMap.set(d, { sunrise, sunset });
        }
      }
      return true;
    }

    function getSunForDate(dateISO){
      return state.sunMap.get(dateISO) || null;
    }

    function isDaytime(dtLocal, sun){
      const sr = DateTime.fromISO(sun.sunrise, { zone: dtLocal.zoneName });
      const ss = DateTime.fromISO(sun.sunset,  { zone: dtLocal.zoneName });
      return (dtLocal >= sr && dtLocal < ss);
    }

    function lastSunriseBefore(dtLocal){
      const d0 = dtLocal.toISODate();
      const dPrev = dtLocal.minus({ days: 1 }).toISODate();

      const sun0 = getSunForDate(d0);
      const sunP = getSunForDate(dPrev);
      if(!sun0 || !sunP) return null;

      const sr0 = DateTime.fromISO(sun0.sunrise, { zone: dtLocal.zoneName });
      const srP = DateTime.fromISO(sunP.sunrise, { zone: dtLocal.zoneName });

      return (dtLocal >= sr0) ? sr0 : srP;
    }

    // ---------- Tamil time conversions ----------
    // 1 naazhigai = 24 minutes
    // 1 saamam = 180 minutes (3 hours) => 8 saamam per 24h
    function tamilTimeFromLastSunrise(dtLocal, lastSunrise){
      const diffMin = dtLocal.diff(lastSunrise, "minutes").minutes;
      const totalMin = ((diffMin % 1440) + 1440) % 1440; // 0..1439
      const nazhigai = Math.floor(totalMin / 24) + 1;     // 1..60
      const minuteInNazhi = Math.floor(totalMin % 24);    // 0..23
      const saamam = Math.floor(totalMin / 180) + 1;      // 1..8
      return { totalMin, nazhigai, minuteInNazhi, saamam, vinadi: dtLocal.second };
    }

    // ---------- Disclaimer / Dependencies text ----------
    function disclaimerText(){
      return [
        `${APP_NAME}`,
        `Author: ${AUTHOR_NAME}`,
        `Email: ${AUTHOR_EMAIL}`,
        ``,
        `DISCLAIMER`,
        `- This page provides calendar/time conversions for convenience.`,
        `- Tamil solar month/day & Tamil year are computed using a SIMPLE APPROXIMATE boundary table (Sankranti-like dates).`,
        `- Panchangam items (Tithi/Nakshatra/Yoga/Karana) are computed using small/approx astronomical formulas for Sun/Moon ecliptic longitudes. Results may differ from official almanacs.`,
        `- Sunrise/Sunset are fetched from a public API for the selected city & date; this is used for day/night and for ‚Äúlast sunrise‚Äù day-cycle.`,
        ``,
        `DEPENDENT SERVICES (required for full functionality)`,
        `1) Open-Meteo Geocoding API (city ‚Üí lat/lon/timezone): https://geocoding-api.open-meteo.com/`,
        `2) Open-Meteo Forecast API (daily sunrise/sunset): https://api.open-meteo.com/`,
        `3) Google Fonts (Tiro Tamil, Roboto): https://fonts.googleapis.com/`,
        `4) Luxon (timezone-aware date/time): https://cdn.jsdelivr.net/`,
        `5) html2canvas (share screenshot): https://cdn.jsdelivr.net/`,
        ``,
        `If any API is blocked/offline, city timezone and sunrise/sunset may fail. The app will show an error box with the failing service.`,
        ``,
        `¬© ${AUTHOR_NAME} ¬∑ ${AUTHOR_EMAIL} ¬∑ ${APP_NAME}`
      ].join("\n");
    }

    // ---------- Info text (calculation details) ----------
    function makeInfoText(obj){
      return [
        `APP: ${APP_NAME}`,
        `Author: ${AUTHOR_NAME}`,
        `Email: ${AUTHOR_EMAIL}`,
        ``,
        `City: ${obj.cityName}`,
        `Lat/Lon: ${obj.lat}, ${obj.lon}`,
        `Device TZ: ${obj.deviceTz}`,
        `City TZ: ${obj.cityTz}`,
        `Using TZ: ${obj.usingTz}`,
        ``,
        `Selected (local): ${obj.dtLocal.toFormat("yyyy-LL-dd HH:mm:ss")} (${obj.dtLocal.zoneName})`,
        `Selected (UTC):   ${obj.dtUtc.toFormat("yyyy-LL-dd HH:mm:ss")} (UTC)`,
        ``,
        `Sunrise: ${obj.sunrise}`,
        `Sunset:  ${obj.sunset}`,
        `Last Sunrise used: ${obj.lastSunrise}`,
        ``,
        `Day/Night: ${obj.dayNight}`,
        `Minutes since last sunrise: ${obj.minutesSinceLastSunrise}`,
        `Nazhi(1..60): ${obj.nazhigai} | minute-in-nazhi(0..23): ${obj.minuteInNazhi} | vinadi: ${obj.vinadi}`,
        `Saamam(1..8): ${obj.saamam}`,
        ``,
        `Sun lon (deg): ${obj.sunLon.toFixed(4)}`,
        `Moon lon (deg): ${obj.moonLon.toFixed(4)}`,
        `Tithi: ${obj.tithiNo} (${obj.tithiName})`,
        `Nakshatra: ${obj.nakNo} (${obj.nakName})`,
        `Yoga: ${obj.yogaNo} (${obj.yogaName})`,
        `Karana: ${obj.karanaName} (half: ${obj.karanaHalf})`,
        ``,
        `---`,
        disclaimerText()
      ].join("\n");
    }

    // ---------- Core ----------
    async function recalcAndRender(){
      clearError();

      // Deep naming everywhere
      document.title = `${APP_NAME} ¬∑ ${AUTHOR_NAME} ¬∑ ${AUTHOR_EMAIL}`;
      cityTitle.textContent = `${state.city || APP_NAME}`;

      deviceTzEl.textContent = state.deviceTz || "UTC";
      cityTzEl.textContent = state.cityTz || "‚Äî";

      // Which timezone is used to interpret selected datetime?
      const mode = modeInput.value;
      const usingTz = (mode === "city" && state.cityTz) ? state.cityTz : state.deviceTz;
      usingTzEl.textContent = usingTz;

      // Parse selected dt in "usingTz"
      const dtLocal = getSelectedDateTime().setZone(usingTz);
      const dtUtc = dtLocal.toUTC();

      // Ensure city is set
      if(state.lat == null || state.lon == null || !state.cityTz){
        await setCity(DEFAULT_CITY, { silent: true });
      }

      // Sunrise/sunset calculations must use CITY timezone (location-based)
      const cityZone = state.cityTz || "UTC";
      const dtCity = dtLocal.setZone(cityZone);

      // Ensure sunrise cache for yesterday..today..tomorrow
      const d0 = dtCity.toISODate();
      const dPrev = dtCity.minus({ days: 1 }).toISODate();
      const dNext = dtCity.plus({ days: 1 }).toISODate();

      sunForDateEl.textContent = d0;

      if(!state.sunMap.has(dPrev) || !state.sunMap.has(d0) || !state.sunMap.has(dNext)){
        try{
          state.lastApiStatus.sunrise = "loading";
          await loadSunriseSunsetRange(state.lat, state.lon, cityZone, dPrev, dNext);
          state.lastApiStatus.sunrise = "ok";
        }catch(e){
          state.lastApiStatus.sunrise = "failed";
          showError("Sunrise/Sunset API failure", e.message, "Try again later or check network/DNS. Some networks block api.open-meteo.com");
          // Still proceed with limited output
        }
      }

      const sun = getSunForDate(d0);
      if(!sun){
        // Cannot compute day/night and last sunrise reliably without sun data
        outDayNight.textContent = "‚Äî";
        outSaamamNo.textContent = "‚Äî";
        outNaz.textContent = "‚Äî";
        outMin.textContent = "‚Äî";
        outVinadi.textContent = dtCity.second;

        // We still compute calendar/panchangam from date
      }

      // Calendar items (CITY date)
      const mInfo = tamilMonthFromDate(dtCity);
      const tDayNo = tamilDayNumber(dtCity, mInfo);
      const yInfo = tamilYearName(dtCity);
      const wdTa = WEEKDAY_TA[dtCity.weekday] || "‚Äî";

      // Panchangam (approx) from UTC moment
      const jd = julianDay(dtUtc);
      const sunLon = sunEclLon(jd);
      const moonLon = moonEclLon(jd);
      const tithi = tithiFromLongitudes(moonLon, sunLon);
      const nak = nakshatraFromMoonLon(moonLon);
      const yoga = yogaFromLongitudes(moonLon, sunLon);
      const kar = karanaFromDiff(tithi.diffDeg);

      // Render: year as ONE value "year_name ‡ÆÜ‡Æ£‡Øç‡Æü‡ØÅ"
      outYear.textContent = `${yInfo.name} ‡ÆÜ‡Æ£‡Øç‡Æü‡ØÅ`;
      outSeason.textContent = mInfo.season;
      outMonth.textContent = mInfo.name;

      outNakshatra.textContent = nak.name;
      outTithi.textContent = tithi.name;

      outDayNum.textContent = tDayNo;
      outWeekday.textContent = wdTa;

      let dayNightTa = "‚Äî";
      let tt = null;
      let lastSunrise = null;

      if(sun){
        dayNightTa = isDaytime(dtCity, sun) ? "‡Æ™‡Æï‡Æ≤‡Øç" : "‡Æá‡Æ∞‡Æµ‡ØÅ";
        lastSunrise = lastSunriseBefore(dtCity);
        if(lastSunrise){
          tt = tamilTimeFromLastSunrise(dtCity, lastSunrise);
          outSaamamNo.textContent = tt.saamam;
          outNaz.textContent = tt.nazhigai;
          outMin.textContent = tt.minuteInNazhi;
          outVinadi.textContent = tt.vinadi;

          const nazCycleFloat = (tt.totalMin / 24);
          outNazCycle.textContent = nazCycleFloat.toFixed(2);
          const saamCycleFloat = nazCycleFloat / 7.5;
          outSaamamCycle.textContent = saamCycleFloat.toFixed(2);
        }else{
          outSaamamNo.textContent = "‚Äî";
          outNaz.textContent = "‚Äî";
          outMin.textContent = "‚Äî";
          outVinadi.textContent = dtCity.second;
          outNazCycle.textContent = "‚Äî";
          outSaamamCycle.textContent = "‚Äî";
        }
      }else{
        outNazCycle.textContent = "‚Äî";
        outSaamamCycle.textContent = "‚Äî";
      }

      outDayNight.textContent = dayNightTa;

      // Footer note
      footNote.textContent = `${APP_NAME} ¬∑ ${AUTHOR_NAME} ¬∑ ${AUTHOR_EMAIL}`;

      // Info box includes disclaimer + dependencies
      const info = {
        cityName: `${state.city}${state.country ? ", " + state.country : ""}`,
        lat: state.lat,
        lon: state.lon,
        deviceTz: state.deviceTz,
        cityTz: cityZone,
        usingTz,
        dtLocal,
        dtUtc,
        sunrise: sun?.sunrise || "‚Äî",
        sunset:  sun?.sunset  || "‚Äî",
        lastSunrise: lastSunrise ? lastSunrise.toISO() : "‚Äî",
        dayNight: dayNightTa,
        minutesSinceLastSunrise: tt ? Math.round(tt.totalMin) : "‚Äî",
        nazhigai: tt ? tt.nazhigai : "‚Äî",
        minuteInNazhi: tt ? tt.minuteInNazhi : "‚Äî",
        vinadi: dtCity.second,
        saamam: tt ? tt.saamam : "‚Äî",
        sunLon,
        moonLon,
        tithiNo: tithi.tithi,
        tithiName: tithi.name,
        nakNo: nak.nak,
        nakName: nak.name,
        yogaNo: yoga.yoga,
        yogaName: yoga.name,
        karanaName: kar.name,
        karanaHalf: kar.half
      };
      infoBox.textContent = makeInfoText(info);
    }

    async function setCity(cityName, { silent=false } = {}){
      clearError();
      const q = (cityName || "").trim();
      if(!q) return;

      if(!silent){
        cityGo.disabled = true;
        cityGo.textContent = "Loading‚Ä¶";
      }

      try{
        state.lastApiStatus.geocoding = "loading";
        const g = await geocodeCity(q);
        state.lastApiStatus.geocoding = "ok";

        state.city = [g.name, g.admin1].filter(Boolean).join(", ");
        state.country = g.country || "";
        state.lat = g.lat;
        state.lon = g.lon;
        state.cityTz = g.tz;

        // clear sun cache for new location
        state.sunMap.clear();

        cityTitle.textContent = state.city;
        cityTzEl.textContent = state.cityTz;

        await recalcAndRender();
      }catch(e){
        state.lastApiStatus.geocoding = "failed";
        showError("Geocoding API failure", e.message, "Try a more specific city name like ‚ÄúMadurai, India‚Äù or check network/DNS.");
      }finally{
        if(!silent){
          cityGo.disabled = false;
          cityGo.textContent = "Search";
        }
      }
    }

    // ---------- Share (screenshot) ----------
    async function shareScreenshot(){
      clearError();

      const shareArea = document.getElementById("shareArea");
      const dt = getSelectedDateTime();
      const labelCity = state.city || DEFAULT_CITY;
      const fileName = `${APP_NAME}-${labelCity}-${dt.toFormat ? "" : ""}`; // luxon dt already
      const safeName = `${APP_NAME}-${labelCity}-${dt.toFormat("yyyyLLdd-HHmm")}`.replace(/[^\w\u0B80-\u0BFF\-]+/g, "_");

      // Enter "sharing" mode to hide buttons/details/footer
      document.body.classList.add("sharing");

      // Give layout a tick to apply styles
      await new Promise(r => setTimeout(r, 80));

      try{
        const canvas = await html2canvas(shareArea, {
          backgroundColor: "#070a10",
          scale: Math.min(2, window.devicePixelRatio || 1),
          useCORS: true
        });

        const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png", 0.95));
        if(!blob) throw new Error("Screenshot blob failed");

        const shareTitle = `${APP_NAME}`;
        const shareText = `${APP_NAME}\n${labelCity}\n${AUTHOR_NAME} ¬∑ ${AUTHOR_EMAIL}`;

        // Web Share with file (Android Chrome etc)
        if(navigator.canShare && navigator.canShare({ files: [new File([blob], `${safeName}.png`, { type: "image/png" })] })){
          const file = new File([blob], `${safeName}.png`, { type: "image/png" });
          await navigator.share({ title: shareTitle, text: shareText, files: [file] });
        } else if (navigator.share) {
          // fallback: share without file
          const url = location.href;
          await navigator.share({ title: shareTitle, text: shareText, url });
        } else {
          // fallback: download
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = `${safeName}.png`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(a.href);
        }
      }catch(e){
        showError("Share failed", e.message, "If share is blocked, try again or use a different browser. Screenshot needs html2canvas CDN access.");
      }finally{
        document.body.classList.remove("sharing");
      }
    }

    // ---------- Events ----------
    const btnNow = document.getElementById("btnNow");
    const btnRefresh = document.getElementById("btnRefresh");
    const btnShare = document.getElementById("btnShare");
    const cityGo = document.getElementById("cityGo");
    const cityInput = document.getElementById("cityInput");
    const dtInput = document.getElementById("dtInput");
    const modeInput = document.getElementById("modeInput");

    cityGo.addEventListener("click", () => setCity(cityInput.value));
    cityInput.addEventListener("keydown", (e) => { if(e.key === "Enter") setCity(cityInput.value); });

    btnNow.addEventListener("click", async () => {
      setDtInputNowInDeviceTz();
      await recalcAndRender();
    });

    btnRefresh.addEventListener("click", async () => {
      await recalcAndRender();
    });

    btnShare.addEventListener("click", shareScreenshot);

    dtInput.addEventListener("change", () => recalcAndRender().catch(e => showError("Recalc failed", e.message)));
    modeInput.addEventListener("change", () => recalcAndRender().catch(e => showError("Recalc failed", e.message)));

    // ---------- Init ----------
    (async function init(){
      // Deep naming
      document.title = `${APP_NAME} ¬∑ ${AUTHOR_NAME} ¬∑ ${AUTHOR_EMAIL}`;
      cityTitle.textContent = APP_NAME;

      // Default values
      document.getElementById("deviceTz").textContent = state.deviceTz;
      setDtInputNowInDeviceTz();

      // Info box starts with disclaimer even before calculations
      infoBox.textContent = disclaimerText();

      // Load default city
      await setCity(DEFAULT_CITY, { silent: true });

      // First render
      await recalcAndRender();
    })().catch(e => showError("Init failed", e.message));
  </script>

  <!-- Hidden deep signature (again) -->
  <!-- ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç | Ramar Kandasamy | ram.kabil@gmailcom | ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç ‡Æï‡Ææ‡Æ≤ ‡Æ®‡Øá‡Æ∞‡ÆÆ‡Øç | Ramar Kandasamy | ram.kabil@gmailcom -->
</body>
</html>
